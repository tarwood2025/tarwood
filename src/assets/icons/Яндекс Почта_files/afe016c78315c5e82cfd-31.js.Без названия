/*! For license information please see afe016c78315c5e82cfd-31.js.LICENSE */
webpackJsonp([31],{1007:function(e,t,n){"use strict";t.a=function(e){return Boolean(e.inreplyto)?{initial_to:e.to,initial_cc:e.cc}:{}}},197:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2968);n.n(i);Jane.module("compose2.js",function(){ns.View.prototype.composeUpdate=function(){this.info&&!this.info.isCollection&&this.invalidate(),this.isVisible()&&this.getModel("compose-state").trigger("ns-model:compose:update")},Daria.composeEqualRoutes=function(e,t){var n=_.omit(t.params,["_cuid"]),i=_.omit(e.params,["_cuid"]);return!(e.page!==t.page||!_.isEqual(i,n))},n(2969),n(2970),n(2971),n(2978),n(3002)})},2968:function(e,t){},2969:function(e,t){Daria.UI=Daria.UI||{},Daria.UI.IEvent=function(e){e=e||{};var t={},n={},i={},r={};function s(n){return t[n]||(r[n]=e[n]||"unique",t[n]=$.Callbacks(r[n])),t[n]}function o(e){if(i[e]){for(var t=0,n=i[e].length;t<n;t++)s(e).add(i[e][t]);delete i[e]}}return{_events:{lock:function(e){n[e]=!0,i[e]=[]},unlock:function(e){delete n[e]},empty:function(e){e?(s(e).empty(),delete i[e]):(t={},i={})}},on:function(e,t){n[e]?-1===$.inArray(t,i[e])&&i[e].push(t):s(e).add(t);return this},off:function(e,t){if(n[e]){var r=$.inArray(t,i[e]);-1!==r&&i[e].splice(r,1)}return s(e).remove(t),this},trigger:function(e,t){if(!n[e]){var i=r[e]&&-1!==r[e].indexOf("memory");i||o(e),s(e).fireWith(this,t),i&&o(e)}return this}}}},2970:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"composeKey",function(){return i}),n.d(t,"composeParams",function(){return r});var i=function(e){return e&&e._cuid||"compose"},r=_.memoize(function(e){return _.pick(e,["ids","tids","oper","qrIds","_cuid"])},i);Daria.getPageComposeIds=function(){var e=Daria.router.getCurrentParams(),t=i(e);if(Daria.composeHasParams(t))return t},Daria.getRealComposeIds=function(e){var t=e.ids,n=Daria.router.getCurrentParams();return!t&&r.cache.has(Daria.composeKey(n))&&Daria.isComposePage()&&n._cuid&&n.ids&&(t=n.ids),t},Daria.composeHasParams=function(e){var t=r.cache.get(e);return!_.isUndefined(t)&&ns.Model.get("compose-message",t).isValid()}},2971:function(e,t,n){Daria.ComposeComponents={},n(2972),n(2973),n(2974),n(2975),n(2976),n(2977)},2972:function(e,t){Daria.ComposeComponents.confirmations={_confirmations:{},addConfirmation:function(e,t){this._confirmations[e]=t},getConfirmation:function(e){return this._confirmations[e]},getConfirmations:function(){return _.map(this._confirmations,function(e){return e})}}},2973:function(e,t){!function(){var e="send-without-to";Daria.ComposeComponents.confirmations.addConfirmation(e,function(t){var n=t.get(".to"),i=t.get(".cc"),r=t.get(".bcc");return!(n||!i&&!r)&&e})}()},2974:function(e,t){!function(){var e="attachments-forgotten",t=new RegExp(["attach","аттач","прилагается","приложил","прикладываю","прикрепляю","приложенный","приложенном","вложил","вложение","вложенном","вложенный","вкладываю","прилагаю","см. файл","см.файл","лови файл","прикрепил","во вложении","в приложении"].join("|"),"i");Daria.ComposeComponents.confirmations.addConfirmation(e,function(n,i){if(n.hasAttach())return!1;var r=n.get(".send"),s=n.get(".subj");/^RE:/i.test(s)||(r=s+" "+r),r=(r=(r=r.replace(new RegExp("(?:^\\s*>.*$)|(?:[\\n\\r])","gmi"),"")).replace(/<blockquote[^>]*>.*<\/blockquote>/gi,"")).replace(/<[^>]+>/g,"");var o=t.exec(r);if(!o)return!1;var a=[];return $.each([o.index,o.index+o[0].length-1],function(e,t){e=2*e-1;for(var n=3,i=!1,s=t,o=r.length;s>=0&&s<o;s+=e)if(/[\s,.!?\-+:;()]/i.test(r.charAt(s))){if(!i){if(!--n)break;i=!0}}else i=!1;a.push(s)}),i.stopWordGroup=$.trim(r.substring.apply(r,a)),e})}()},2975:function(e,t){!function(e,t){"use strict";t.Signature=function(){e.extend(this,t.UI.IEvent()),this._log("create"),this.__init=!1,this._isMouseenter=!1,this._isMouseleave=!0,this._coordYBegin=0,this._coordYEnd=0,this._currentYCursor=0,this._limitRangeFind=100,this._maxSignLine=100,this._range=[],this._updateCoords=_.debounce(this._updateCoords,0),this._onInput=_.debounce(this._onInput,50)};var n=t.Signature.prototype;n._log=function(){},n._mouseEnter=function(){this._isMouseenter||(this._isMouseenter=!0,this._isMouseleave=!1,this.trigger("mouseenter",[this]))},n._mouseLeave=function(){this._isMouseleave||(this._isMouseleave=!0,this._isMouseenter=!1,this.trigger("mouseleave",[this]))},n._mouseMove=function(e){this._coordYBegin>=this._coordYEnd?this._mouseLeave():(this._currentYCursor=e,this._currentYCursor>=this._coordYBegin&&this._currentYCursor<=this._coordYEnd?(this._mouseEnter(),this.trigger("mousemove",[this])):this._mouseLeave())},n._updateCoords=function(){var e=this._offset();e&&(this._log("_updateCoords"),this._coordYBegin===e.top&&this._coordYEnd===e.bottom||(this._coordYBegin=e.top>0?e.top:0,this._coordYEnd=e.bottom>0?e.bottom:0,this._currentYCursor&&this._mouseMove(this._currentYCursor),this.trigger("change",[this])))},n.__onInput=function(){if(this._log("__onInput"),this._range=this._findRange(),!this._range.length)return this._coordYBegin=0,this._coordYEnd=0,void this._mouseLeave();this._updateCoords()},n._onInput=function(t){t&&e.inArray(t.keyCode,[37,38,39,40,16,17,18])>-1||(this._log("_onInput"),this.__onInput())},n._onClick=function(){this._range.length&&this._isMouseenter&&(this._log("_onClick"),this.trigger("click",[this]))},n._onScroll=function(){this._range.length&&(this._log("_onScroll"),this._updateCoords())},n.isMouseEntered=function(){return this._isMouseenter},n.offset=function(){return{top:this._coordYBegin,bottom:this._coordYEnd}},n.update=function(){this._range=this._findRange();var e=this._offset();e&&(this._coordYBegin=e.top>0?e.top:0,this._coordYEnd=e.bottom>0?e.bottom:0,this._currentYCursor&&this._mouseMove(this._currentYCursor),this.trigger("change",[this]))},n._destroy=function(e){this.__init&&(this._log("_destroy"),this.__init=!1,this._updateCoords.cancel(),this._onInput.cancel(),this._events.empty(),this._range=[],this._currentYCursor=0,this._coordYBegin=0,this._coordYEnd=0,this._isMouseenter=!1,this._isMouseleave=!0,e&&e.call(this))},n._init=function(e){this.__init||(this._log("_init"),this.__init=!0,e&&e.call(this),this.__onInput())},n.__offsetY=function(e){var t;return void 0!==e.offsetY?t=e.offsetY:e.originalEvent&&void 0!==e.originalEvent.layerY&&(t=e.originalEvent.layerY),t},n.setFirstSignatureMatch=function(e){this._firstSignatureMatch=e},n.getFirstSignatureMatch=function(){return this._firstSignatureMatch||"--\\s"},n._offset=function(){},n.getLinesCount=function(){return 0},n._findRange=function(){return[]},n._onMouseMove=function(){},n._onMouseLeave=function(){},n._onMouseEnter=function(){},n.destroy=function(){},n.init=function(){},n.select=function(){},n.replace=function(){},n.get=function(){},n.getText=function(){}}(jQuery,Daria)},2976:function(e,t){!function(e,t){"use strict";t.SignatureTextarea=function(n){t.SignatureTextarea.superClass.constructor.apply(this,arguments),this._$node=e(n)},Jane.extend(t.SignatureTextarea,t.Signature);var n=t.Signature.prototype;n._widthNode=function(){var e=0,t=this._$node[0].scrollWidth||this._$node[0].clientWidth;return window.getComputedStyle&&(e=-1!==(e=window.getComputedStyle(this._$node[0],null).getPropertyValue("width")).indexOf("px")?parseFloat(e):0),e?Math.min(e,t):t},n._textCoords=function(t,n,i){this._$placeholder.width(this._widthNode()).text(t);var r=parseInt(this._$placeholder.css("top"),10),s=this._$placeholder[0].firstChild,o=document.createRange();o.setStart(s,n),o.setEnd(s,i);var a=o.cloneRange(),u={};if(!Modernizr.msie&&!Modernizr.opera&&(a.getBoundingClientRect&&(u={top:(u=a.getBoundingClientRect()).top,bottom:u.bottom}),!u.top&&!u.bottom&&a.getClientRects)){var c=a.getClientRects();c.length&&(u.top=c[0].top,u.bottom=c[c.length-1].bottom)}if(u.top||u.bottom){var l=e(window).scrollTop();u.top=u.top+l,u.bottom=u.bottom+l}else{a.surroundContents(this._highlight);var d=e(this._highlight);u.top=d.offset().top,u.bottom=u.top+d.height()}return u.top&&u.bottom?(u.top=u.top-r,u.bottom=u.bottom-r,u):null},n._offset=function(){if(!this._range.length)return null;var e=this._$node.scrollTop();return{top:this._range[0].top-e,bottom:this._range[1].bottom-e}},n._findRange=function(){if(!this._lineHeight)return[];for(var e,t=new RegExp("^"+this.getFirstSignatureMatch()+"$","gm"),n=this._$node.val(),i=/^--------[^\-]+.*--------$/gm,r=[-1,-1],s=!1;null!==(e=i.exec(n));)s||(s=!0,r[0]=e.index),r[1]=i.lastIndex;var o,a,u=t.exec(n);if(u&&u.index>r[0]&&u.index<r[1]&&(t.lastIndex=r[1],u=t.exec(n)),u){o={simbol:u.index,simbolOffset:t.lastIndex+1,top:void 0};var c,l=this._maxSignLine,d=/^.+$/gm,f=!1,h=[0,0],m=/^\s*>/,g=/^\s*$/;for(d.lastIndex=t.lastIndex;null!==(c=d.exec(n))&&l;){if(m.test(c[0])){f=!0;break}if(d.lastIndex>=r[0]&&d.lastIndex<=r[1])break;g.test(c[0])||(h=[d.lastIndex,h[0]]),l--}if(h=f&&h[1]?h[1]:h[0]?h[0]:o.simbolOffset-1){a={simbol:h,bottom:void 0};var p=this._textCoords(n,o.simbol,a.simbol);p?(o.top=p.top,a.bottom=p.bottom):(o=null,a=null)}}return o&&a?[o,a]:[]},n._onMouseMove=function(e){this._isNodeMouseenter||this._onMouseEnter(e),this._log("mousemove"),this._mouseMove(this.__offsetY(e))},n._onMouseLeave=function(){this._log("mouseleave"),this._mouseLeave(),this._currentYCursor=0,this._isNodeMouseenter=!1},n._onMouseEnter=function(e){this._log("mouseenter"),this._currentYCursor=this.__offsetY(e),this.__onInput(),this._isNodeMouseenter=!0},n.get=function(){return this._range.length?this._$node.val().slice(this._range[0].simbol,this._range[1].simbol):""},n.getText=function(){return this.get()},n.replace=function(e){if(this._range.length){var t=this._$node.val();t=t.substr(0,this._range[0].simbol)+e+t.substr(this._range[1].simbol),this._$node.val(t),this.__onInput()}},n.select=function(){this._range.length&&t.setSelection(this._$node[0],this._range[0].simbol,this._range[1].simbol)},n.init=function(t,n){t=t||{},this._init(function(){this.setFirstSignatureMatch(t.firstSignatureMatch);var i=parseInt(this._$node.css("font-size"),10)||13;if(this._lineHeight=i+2,this._$node.css("line-height",this._lineHeight+"px"),this._highlight=document.createElement("span"),this._$placeholder=e("<pre></pre>").css({font:this._$node.css("font"),fontFamily:this._$node.css("fontFamily"),fontSize:this._$node.css("fontSize"),fontStyle:this._$node.css("fontStyle"),fontVariant:this._$node.css("fontVariant"),fontWeight:this._$node.css("fontWeight"),lineHeight:this._$node.css("lineHeight"),padding:this._$node.css("padding"),paddingTop:this._$node.css("paddingTop"),paddingBottom:this._$node.css("paddingTop"),paddingLeft:this._$node.css("paddingLeft"),paddingRight:this._$node.css("paddingRight"),margin:this._$node.css("margin"),marginTop:this._$node.css("marginTop"),marginBottom:this._$node.css("marginTop"),marginLeft:this._$node.css("marginLeft"),marginRight:this._$node.css("marginRight"),width:this._widthNode()+"px",wordWrap:"break-word",whiteSpace:"pre-wrap",visibility:"hidden",position:"absolute",top:"-9999px",left:"-9999px"}).appendTo("body"),this._$node.on("keyup",e.proxy(this._onInput,this)).on("mouseleave",e.proxy(this._onMouseLeave,this)).on("mouseenter",e.proxy(this._onMouseEnter,this)).on("click",e.proxy(this._onClick,this)).on("mousemove",e.proxy(this._onMouseMove,this)).on("scroll",e.proxy(this._onScroll,this)),Modernizr.msie){var r=this,s=this._$node.css("overflow-y");this._$node.css("overflow-y","hidden"),setTimeout(function(){r._$node.css("overflow-y",s)},0)}n&&n.call(this)})},n.destroy=function(){this._destroy(function(){this._highlight=null,this._$placeholder.remove(),this._$placeholder=null,this._lineHeight=0,this._$node.off("keyup",e.proxy(this._onInput,this)).off("mouseleave",e.proxy(this._onMouseLeave,this)).off("mouseenter",e.proxy(this._onMouseEnter,this)).off("click",e.proxy(this._onClick,this)).off("mousemove",e.proxy(this._onMouseMove,this)).off("scroll",e.proxy(this._onScroll,this))})},e.fn.signature=function(){return this.each(function(){this.signature||(this.signature=new t.SignatureTextarea(this))})},e.fn.signatureDestroy=function(){return this.each(function(){this.signature&&(this.signature.destroy(),this.signature=null,delete this.signature)})}}(jQuery,Daria)},2977:function(e,t){!function(e,t){"use strict";t.SignatureCkeditor=function(n){t.SignatureCkeditor.superClass.constructor.apply(this,arguments),this._ed=n,this._$node=e(this._ed.editable().$),this._isFirstSignature=!0,this._isNormalizeSupport="normalize"in document.createElement("div")},Jane.extend(t.SignatureCkeditor,t.Signature);var n=t.SignatureCkeditor.prototype;n._offset=function(){if(!this._range.length)return null;var e,t,n;try{if(!(e=this._range[0][0].getBoundingClientRect()).height)return null;if(!(t=this._range[1][0].getBoundingClientRect()).height)return null;if(!(n=this._$node[0].getBoundingClientRect()).height)return null}catch(e){return null}return{top:e.top-n.top,bottom:t.bottom-n.top}},n._findForwardRange=function(){var t=[-1,-1],n=this._ed.getData(!0);if(void 0===n)return t;if(!/<div>--------[^\-]+.*--------<\/div>/i.test(n))return t;var i=this._$node[0],r=i.childNodes.length;if(!r)return t;for(var s,o=0,a=/^--------[^\-]+.*--------$/;o<r;o++)if("DIV"===(s=i.childNodes[o]).nodeName&&a.test(e.text(s))){t[0]=o;break}for(;r--;)if("DIV"===(s=i.childNodes[r]).nodeName&&a.test(e.text(s))){t[1]=r;break}return t},n._checkFirstRange=function(e){var n=t.Html2Text.html2text(e.innerHTML),i=new RegExp("^"+this.getFirstSignatureMatch()+"$","m").exec(n);return!(!i||0!==i.index)},n._findFirstRangeForward=function(e,t){var n,i,r=this._$node[0],s=r.childNodes.length,o=0;if(!((i=e?Math.min(this._limitRangeFind,s-this._limitRangeFind):Math.min(this._limitRangeFind,s))<=o)){for(;o<i;o++)if(!(o>=t[0]&&o<=t[1])){var a=r.childNodes[o];if(this._checkFirstRange(a)){n=a;break}}return n}},n._findFirstRangeBack=function(e,t){var n,i,r=this._$node[0],s=r.childNodes.length,o=s-1;if(!(o<(i=e?Math.max(this._limitRangeFind,s-this._limitRangeFind):Math.max(0,s-this._limitRangeFind)))){for(;o>=i;--o)if(!(o>=t[0]&&o<=t[1])){var a=r.childNodes[o];if(this._checkFirstRange(a)){n=a;break}}return n}},n._findFirstRange=function(){var e,t=this._findForwardRange();return this._isFirstSignature?(e=this._findFirstRangeForward(!1,t))||(e=this._findFirstRangeBack(!0,t)):(e=this._findFirstRangeBack(!1,t))||(e=this._findFirstRangeForward(!0,t)),e},n._findRange=function(){var t,n=this._findFirstRange();if(n){t=[];var i=this._maxSignLine,r=!1,s=/^--------[^\-]+.*--------$/,o=/^\s*>/,a=/^\s*$/,u=/<img[^>]*>/;e(n).nextAll().each(function(){if("BLOCKQUOTE"===this.nodeName)return r=!0,!1;var n=e.text(this);return o.test(n)?(r=!0,!1):!s.test(n)&&(!!i&&(a.test(n)?this.childNodes.length>0&&u.test(this.innerHTML)&&(t=[this,t[0]]):t=[this,t[0]],void i--))}),t=r&&t[1]?t[1]:t[0]?t[0]:n}return n&&t?[e(n),e(t)]:[]},n._createRange=function(){if(!this._range.length)return!1;var e=this._ed.createRange();return this._range[0][0]===this._range[1][0]?e.selectNodeContents(new CKEDITOR.dom.node(this._range[0][0])):(e.setStartBefore(new CKEDITOR.dom.node(this._range[0][0])),e.setEndAfter(new CKEDITOR.dom.node(this._range[1][0]))),e},n._onMouseMove=function(e){this._isNodeMouseenter||this._onMouseEnter(e),this._log("mousemove");var t=e.currentTarget.getBoundingClientRect(),n=e.clientY-t.top;this._mouseMove(n)},n._onMouseLeave=function(){this._log("mouseleave"),this._mouseLeave(),this._currentYCursor=0,this._isNodeMouseenter=!1},n._onMouseEnter=function(e){this._log("mouseenter"),this._currentYCursor=this.__offsetY(e),this.__onInput(),this._isNodeMouseenter=!0},n.get=function(){if(this._range.length)return this._range[0][0]===this._range[1][0]?this._range[0]:this._range[0].nextUntil(this._range[1]).andSelf().add(this._range[1])},n.getText=function(){var e=this.get();return e?e.map(function(){return t.Html2Text.html2text(this.innerHTML).replace(/^[\u0020\u00a0]+$/gm,"")}).get().join("\n"):""},n.replace=function(e){if(this._range.length){var t=this._createRange();this._ed.insertHtml(e,"html",t),this.__onInput()}},n.select=function(){if(!this._range.length)return!1;var e=this._createRange();return this._ed.getSelection().selectRanges([e]),!0},n.init=function(t,n){t=t||{},this._init(function(){"firstSignature"in t&&(this._isFirstSignature=Boolean(t.firstSignature)),this.setFirstSignatureMatch(t.firstSignatureMatch),this._$node.on("mouseleave",e.proxy(this._onMouseLeave,this)).on("mouseenter",e.proxy(this._onMouseEnter,this)).on("scroll",e.proxy(this._onScroll,this)).on("keyup",e.proxy(this._onInput,this)).on("mousemove",e.proxy(this._onMouseMove,this)).on("click",e.proxy(this._onClick,this)),this._ed.on("setData",e.proxy(this.__onInput,this)),n&&n.call(this)})},n.destroy=function(){this._destroy(function(){this._$node.off("mouseleave",e.proxy(this._onMouseLeave,this)).off("mouseenter",e.proxy(this._onMouseEnter,this)).off("scroll",e.proxy(this._onScroll,this)).off("mousemove",e.proxy(this._onMouseMove,this)).off("click",e.proxy(this._onClick,this)).off("keyup",e.proxy(this._onInput,this)),this._ed.removeListener("setData",e.proxy(this.__onInput,this))})}}(jQuery,Daria)},2978:function(e,t,n){n(2979),n(2980),n(2981),n(2982),n(2983),n(2984),n(2985),n(2986),n(2987),n(2988),n(2990),n(2991),n(2992),n(2993),n(2994),n(2995),n(2996),n(2997),n(2998),n(2999),n(3e3),n(3001)},2979:function(e,t){ns.Model.define("do-attach-file-status",{params:{oid:null}})},2980:function(e,t){ns.Model.define("do-attach-file-store",{params:{file:null,checkLimit:null,size:null}})},2981:function(e,t){!function(){var e=ns.ModelStatic,t=["attachments.added","attachments.appended","attachments.updated","attachments.removed","attachments.failed"];ns.Model.define("compose-attachments",{params:{ids:null,tids:null,oper:null},ctor:function(){this._attachments=null,this.processCollectionEvent=this.processCollectionEvent.bind(this)},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this._mComposeMessage||this._mComposeMessage.canRequest();return e&&t},request:function(){var e=this,t=ns.Model.info("message-body").calculateParamsForMessageBody(this.params);return t?ns.request(["message-body","compose-message"],t).then(function(t){e._initByModels(t[0],t[1])}):(e.setData({}),vow.resolve())},init:function(e){this._attachments?this._attachments.setOptionsAndInit(e):(this._attachments=new Daria.AttachmentCollection2(e),this.bindEventsToAttachments())},_initByModels:function(e,t){this.setData({}),this._mMessageBody=e,this._mComposeMessage=t;var n=new Daria.AttachmentCollection2;n.mComposeMessage=t,this._attachments=n,this.bindEventsToAttachments(),t.isReplyAny()||e.getAttachments().forEach(function(e){e.inline||this.addAttachData(e)},this)},addAttachData:function(e,t){if(this._attachments){var n=t&&t.mMessageBody?t.mMessageBody:this._mMessageBody,i=t&&t.mComposeMessage?t.mComposeMessage:this._mComposeMessage,r=Daria.Attachment2.fromMessageBody(e,n,i);return this._attachments.addAttachToCollection(r,{silent:!0,processAttachSize:!0}),r}},destroy:function(){e.prototype.destroy.apply(this,arguments),this.unbindEventsFromAttachments(),this._attachments&&(this._attachments.reset(),this._attachments=null)},bindEventsToAttachments:function(){this._attachments&&_.each(t,function(e){this._attachments.on(e,this.processCollectionEvent)},this)},unbindEventsFromAttachments:function(){this._attachments&&_.each(t,function(e){this._attachments.off(e,this.processCollectionEvent)},this)},processCollectionEvent:function(e,t){this.trigger("ns-model:"+e,t)},addAttach:function(e){this._attachments&&(e.resource?this._attachments.addDiskAttach(e.id,e.resource):this._attachments.add(e.input,e.files))},appendAttach:function(e,t,n){this._attachments&&this._attachments._appendAttach(e,t,n)},drawAttaches:function(){if(this._attachments){var e=this.params.ids||Daria.getPageComposeIds();this._attachments.redrawAttachesBulk(null,e)}},updateAfterSave:function(e,t){this._attachments&&this._attachments.updateAfterSave(e,t,!0)},isUploading:function(){return this._attachments&&this._attachments.isUploading()},isFailed:function(){return!!this._attachments&&this._attachments.isFailed()},hasFiles:function(){return this._attachments&&this._attachments.hasFiles()},retryAttach:function(e){this._attachments.retryAttach(e)},getSummary:function(){return this._attachments.getSummary()}}})}()},2982:function(e,t){ns.Model.define("disk-default-folders",{methods:{isPhotostream:function(e){return e&&this.get(".photostream")===e}}})},2983:function(e,t){!function(e,t){var n=null;ns.Model.define("disk-resources",{params:{path:null,offset:null,sort:null,order:null},methods:{cancelledAttachPaths:[],getDefaultSort:function(e){return ns.Model.get("disk-default-folders").isPhotostream(e)?"etime":"name"},removeAttach:function(e){this.cancelledAttachPaths.push(e)},getDefaultOrder:function(e){return ns.Model.get("disk-default-folders").isPhotostream(e)?"0":"1"},deselect:function(){var e=n;n=null,ns.events.trigger("disk-resources.selected",{before:e})},select:function(e){if(e&&e!==n){var t=n;n=e,ns.events.trigger("disk-resources.selected",{before:t,now:e})}},getSelected:function(){return n},extractError:function(e){return 404===Number(jpath(e,".error.http_status")[0])?(ns.events.trigger("disk-resources.not-found",e.error),e.data={},null):e.error},preprocessData:function(e){var t=jpath(e,".resource.resource")[0];if(Array.isArray(t)){if(t.forEach(s),this.params.hasOwnProperty("offset")){var n=$.extend({},this.params);delete n.offset;var i=ns.Model.get(this.id,n),r=i.getData();if(r){var o=no.jpath(".resource",r)[0];o&&(Array.prototype.push.apply(o.resource,t),i.__offset=t.length+(i.__offset||0))}else i.setData(e),i.__offset=t.length;return i.__complete=0===t.length,e}this.__offset=t.length,this.__complete=0===t.length}return e},getPreview:function(e){var t=$.Deferred(),n={private_hash:e,meta:"preview"};return ns.request("do-disk-get-public-preview",n).then(function(e){var n=jpath(e[0].getData(),".resource.meta.preview")[0];n?t.resolve(n):t.reject("no disk preview")},function(){t.reject()}),t.promise()},attach:function(e,t){var n=$.Deferred(),i=this;function r(e,t){ns.forcedRequest("do-disk-attach-file",{src:e,dst:t}).then(function(t){var r=t[0];if(r.getError())ns.Model.invalidate(i.id),n.reject(r.getError());else{var s=r.getData();if(s&&s.oid){var o={oid:s.oid,meta:"short_url,public,size,public_hash"};i.poll(o,e).done(function(e){var t=e.file||e.folder;t.type=e.file?"file":"dir",n.resolve({url:t.meta&&t.meta.short_url,name:t.name,type:t.type,size:t.meta&&t.meta.size,hash:t.meta&&t.meta.public_hash})}).fail(function(e){n.reject(e)})}else n.reject("disk-attach-file: no data oid")}},function(e){ns.Model.invalidate(i.id),n.reject(e.data||e)})}return r(e,t),n.promise()},poll:function(e,t){var n=$.Deferred(),i=1500,r=this;return function s(){ns.forcedRequest("do-attach-file-status",e).then(function(e){var o=e[0],a=jpath(o.getData(),".operation")[0];if(!a)return n.reject("attach file status: unknown operation");if(-1!==r.cancelledAttachPaths.indexOf(t))return _.remove(r.cancelledAttachPaths,t),n.reject("attach file status: uknown resourceId");var u=a.status;"EXECUTING"===u||"WAITING"===u?window.setTimeout(s,i):"FAILED"===u?n.reject(u.error):"DONE"===u&&n.resolve(a)},function(){n.reject()})}(),n.promise()},loadMore:function(e){var t=$.Deferred(),n=$.extend({},e);delete n.offset;var i=ns.Model.get(this.id,n);return i.__complete?t.reject():(ns.forcedRequest("disk-resources",$.extend({offset:i.__offset},n)).then(function(e){var n=e[0],i=no.jpath(".resource.resource",n.getData())[0];if(i){var r=i[0];if(r)return t.resolve(r)}t.reject("disk-resources: no resource")},function(){t.reject()}),t.promise())},find:function(e){var n=t.utils.dirname(e)+"/",i=ns.Model.get(this.id,{path:n,sort:this.getDefaultSort(n),order:this.getDefaultOrder(n)});if(!i.getData()||!i.get(".resource")||!i.get(".resource")[0])return!1;for(var r=i.get(".resource")[0],s=0,o=r.resource.length;s<o;s+=1)if(r.resource[s].id===e)return r.resource[s];return!1}}});var i=new RegExp("("+t.Config.domainZonesForReg+"|([^\\.]+)$)"),r=/^(https?:)/;function s(e){e.meta&&e.meta.sizes&&$.each(e.meta.sizes,function(n,i){var s=t.Config["downloader-domain-zone"];"mail"===e.service?-1===i.url.indexOf("yandex.net")&&(i.url=o(i.url,s)):"ua"===s&&(i.url=o(i.url,"ru")),i.url=function(e){return e.replace(r,"")}(i.url)})}function o(e,t){var n=e.match(/(?:(?:https?\:)?\/\/)?[^\/]*/g)[0];return e.replace(n,n.replace(i,t))}}(Jane,Daria)},2984:function(e,t){ns.Model.define("do-disk-attach-file",{params:{dst:null,src:null}})},2985:function(e,t){ns.Model.define("do-disk-get-public-preview",{params:{private_hash:null,meta:null}})},2986:function(e,t){!function(){var e="no_reply_notify",t="no_reply_notify_time",n="noreply_popup_shown",i=[{time:{hours:1}},{time:{hours:12}},{time:{days:1}},{time:{days:2}},{time:{days:3}},{time:{days:5},default:!0},{time:{weeks:1}},{time:{weeks:2}}];ns.Model.define("compose-notify-noreply-options",{params:{ids:null,oper:null},methods:{request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){return[{id:"settings"}]},_initFromModels:function(e){this.mSettings=e[0],this.setData({enabledNotify:!1,alwaysNotify:!1,currentTimeDelta:null,timeDeltaItems:this._generateTimeDeltaItems(i)}),this.initData()},_getTimeDeltasUnitToStore:function(){return"seconds"},_generateTimeDeltaItems:function(e){var t=this.mSettings.getSetting("no_reply_notify_time"),n=this._getTimeDeltasUnitToStore(),i=Boolean(this.isSetInSettings()&&t);return t=t?parseInt(t,10):0,e=_.clone(e,!0),_.map(e,function(e){var r=!1,s=Daria.timify(e.time,n);return i?r=s===t:e.default&&(r=!0),_.extend(e,{value:Daria.timify(e.time,n),text:Jane.Date.daysIntervalLocalization(e.time,!0),selected:r})})},getCurrentTimeDelta:function(){return this.get(".currentTimeDelta")},setCurrentTimeDelta:function(e){(e=this.findTimeDeltaItem(e))||(e=this.getDefaultTimeDeltaItem()),this.set(".currentTimeDelta",e),this.set(".enabledNotify",!0)},getCurrentTimeDeltaLocalizedText:function(){var e=Jane.Date.daysIntervalLocalization(this.getCurrentTimeDelta().time);return i18n("%Compose_Checkbox_No_Reply_Active_Text_3",e)},findTimeDeltaItem:function(e){var t=e;return e&&e.value&&(t={value:Number(e.value)}),_.find(this.get(".timeDeltaItems"),t)},getSelectedTimeDeltaItem:function(){return this.findTimeDeltaItem({selected:!0})},getDefaultTimeDeltaItem:function(){return this.findTimeDeltaItem({default:!0})},isSetInSettings:function(){return Boolean(this.mSettings.isSet(e))},setAlwaysNotifyOption:function(n){var i={};n?(i[e]=!0,i[t]=this.getCurrentTimeDelta().value,this.set(".alwaysNotify",!0),this.set(".enabledNotify",!0)):(i[e]=!1,this.set(".alwaysNotify",!1)),this.mSettings.setSettings(i)},wasFirstVisitPopupShown:function(){return this.mSettings.isSet(n)},setFirstVisitPopupWasShown:function(){this.mSettings.setSettingOn(n)},initData:function(){this.set(".currentTimeDelta",this.getSelectedTimeDeltaItem()),this.set(".enabledNotify",this.isSetInSettings()),this.set(".alwaysNotify",this.isSetInSettings())}}})}()},2987:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(1428);!function(){var e=Daria.Constants.CONTACTS.DELIMITER,t=Vow.resolve();ns.Model.define("compose-predefined-data",{events:{"ns-model-init":"_onInit"},params:{},methods:{request:function(){return t},_replaceParams:{mailto:"to",body:"send",subject:"subj"},_pickableParams:["to","cc","bcc","save_symbol","send","subj","qrText"],_normalizableParams:["to","cc","bcc"],_onInit:function(){var e=this._createDataFromUrl();this.setData(e),_.isEmpty(e)||this._cleanUrl()},_replaceParamsCallback:function(e,t){this.hasOwnProperty(t)&&(this[e]=this[t],delete this[t])},_createDataFromUrl:function(){return Daria.isComposePage()?this.extractDataFromParams(Daria.router.getCurrentParams()):{}},extractDataFromParams:function(t){var n=_.clone(t);_.forEach(this._replaceParams,this._replaceParamsCallback,n),_.forEach(this._normalizableParams,function(t){var i=n[t];if(i){var r=Jane.FormValidation.splitContacts(i);r.forEach(function(e){Jane.FormValidation.reEmail.test(e.name||"")&&(e.name=e.email)});var s=_.map(r,Jane.FormValidation.obj2contact);n[t]=s.join(e)}});var i=_.pick(n,this._pickableParams);return i.send&&(i.send=this._getBody(i.send)),i.qrText&&(i.qrText=this._getBody(i.qrText)),i},_getBody:function(e){if(this._shouldReturnPlainText())return this._isHtml(e)?Daria.Html2Text.html2text(e):e;this._isHtml(e)||(e=_.escape(e).replace(/(?:\r\n|\r|\n)/g,"<br>"));return i.a.sanitize(e,{ALLOW_DATA_ATTR:!1,USE_PROFILES:{html:!0}})},_isHtml:function(e){var t=(new DOMParser).parseFromString(e,"text/html");return Array.from(t.body.childNodes).some(function(e){return 1===e.nodeType})},_shouldReturnPlainText:function(){return Daria.UA.isMobile},_cleanUrl:function(){var e=this._pickableParams.concat(Object.keys(this._replaceParams)),t=_.omit(Daria.router.getCurrentParams(),e);ns.page.replacePage(Daria.router.getCurrentPage(),t)}}})}()},2988:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2989),r=n(720),s=n(715),o=n(997),a=n(1006),u=n(1007),c=n(338),l=(n.n(c),n(136)),d=(n.n(l),n(28));function f(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(){var e=Daria.Constants.CONTACTS.DELIMITER,t={att_ids:null,bcc:"",captcha_entered:null,captcha_key:null,cc:"",charset:null,confirm_limit:null,current_folder:null,doit:null,errors:{to:"",cc:"",bcc:"",phone:""},fid:null,from_mailbox:null,from_name:null,get_abook:null,html:null,idcs:null,ids:[],ign_overwrite:null,initial_cc:"",initial_to:"",inreplyto:null,lids:[],mark_as:null,mark_ids:[],disk_att:null,nosave:null,nosend:null,notify_on_send:null,overwrite:null,parts:null,phone:null,references:null,remind_period:null,"recipients-diff":{added:[],removed:[]},retpath:null,returl:null,saveDraft:null,save_symbol:l.WellKnownFolderSymbol.DRAFT,send:"",send_time:null,store_fid:null,store_name:null,strict_charset:null,style:null,subj:null,to:"",ttype:null,where:null,withUpdatedUndoAndDelayedErrorHandling:"yes"},n=_.map(["to","cc","bcc","phone","subj","send","from_mailbox","from_name","ttype","att_ids","parts","disk_att","save_symbol","lids"],function(e){return"."+e}),m=ns.Model;ns.Model.define("compose-message",{params:{ids:null,tids:null,oper:null},events:{"ns-model-destroyed":"_onDestroyed","ns-model-changed.to":"_onRecipientsChanged","ns-model-changed.cc":"_onRecipientsChanged","ns-model-changed.bcc":"_onRecipientsChanged"},ctor:function(){this._attachments={},this.mSettings=null,this.mComposePredefinedData=null,this.mMessage=null,this.mMessageBody=null,this.mComposeState=null,this._saveDraftPromise=null,this._cancelled=!1,this._cancelSendCallback=null,this._isIgnoreUndo=!1,this._syncService=new s.a},methods:{_onDestroyed:function(){this._isDirty=!1,this._cancelled=!1,this._cancelSendCallback=null,this._isIgnoreUndo=!1},setIfChanged:function(e,t){if(this.isValid()&&this.data){var n=!0;if(-1!==[".to",".cc",".bcc"].indexOf(e)){var i=/,\s*$/;n=this.get(e).replace(i,"")!==t.replace(i,"")}n&&ns.Model.prototype.setIfChanged.apply(this,arguments)}},_dataPathToActionLogName:{".to":"редактирование письма/получатель (To:)",".subj":"редактирование письма/тема",".send":"редактирование письма/текст",".parts":"редактирование письма/аттачи",".disk_att":"редактирование письма/аттачи",".parts_json":"редактирование письма/аттачи"},set:function(e,t){if(!_.isEqual(t,this.get(e))){_.contains(n,e)&&(this._isDirty=!0);var i=Daria.SendMail.getUndoSendLogger(this.params.ids),r=this._dataPathToActionLogName[e];return r&&i.logActionOnceAfterCancel(r),m.prototype.set.apply(this,arguments)}},setData:function(){return this._isDirty=!0,m.prototype.setData.apply(this,arguments)},setPhoneIfExist:function(e,t){if(!this.get(".phone")||t){var n=ns.Model.get("abook-contacts").getContactDataByEmail(e);if(n&&n.cid){var i=ns.Model.get("abook-contact",{cid:n.cid,shared:n.isShared}),r=i.isValid()&&i.getPhone();return r&&this.setIfChanged(".phone",r),vow.Promise.resolve()}return ns.request("abook-contact",{email:e}).then(function(e){var t=e[0].getPhone();t&&this.setIfChanged(".phone",t)},this)}},setSingleRecipient:function(e){this.setIfChanged(".to",e),this.setIfChanged(".cc",""),this.setIfChanged(".bcc","")},canRequest:function(){var e=ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params),t=ns.Model.get("message-body",e),n=ns.Model.get("signs");return t.canRequest()&&!t.get(".error")&&n.status!==ns.M.STATUS.ERROR},request:function(){var e=this;return Daria.requestModelsForCompose(this.params).then(function(t){return e._initFromModels(t)})},isDraft:function(){return this.composeParamsService.isDraft()},getMessageType:function(){return this.composeParamsService.getMessageType()},getDraftMid:function(){var e=this.get(".overwrite");if(this.isDraft()&&e)return e},getTemplateMid:function(){var e=this.get(".overwrite");if(this.isTemplate()&&e)return e},_constructModelRequest:function(){var e=[{id:"settings"},{id:"compose-predefined-data"}];return this.params.ids&&_.isString(this.params.ids)&&!this.params.tids&&e.push({id:"message",params:{ids:this.params.ids}},{id:"message-body",params:ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params)}),e},_prepareDataForSet:function(e){var n=_.extend(_.cloneDeep(t),this.mComposePredefinedData.getData(),e,this._customizerPrepareData),i=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?f(Object(n),!0).forEach(function(t){h(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):f(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({},n,{},Object(u.a)(n));return this.mComposePredefinedData.destroy(),i},_customizerPrepareData:function(e,t,n){return"send"===n?t||e:t},_initFromModels:function(e){this.mMessage=_.find(e,"id","message"),this.mSettings=_.find(e,"id","settings"),this.mMessageBody=_.find(e,"id","message-body"),this.mComposePredefinedData=_.find(e,"id","compose-predefined-data"),this.mComposeState=ns.Model.get("compose-state",this.params);var t=this.mComposePredefinedData.getData();this.composeParamsService=new r.a(this.params,t),this.composeParamsService.newMessageId=Object(a.a)(e);var n=this.composeParamsService.getComposeMessageData();this.needCollapsedQuotedMessage()&&(n.send="",n.collapsedMessage=!0);var i=this._prepareDataForSet(n);this.setData(i),this.markSaved(),this.composeParamsService.data=this.data},isMessageCollapsed:function(){return Boolean(this.get(".collapsedMessage"))},needCollapsedQuotedMessage:function(){return!Daria.isComposePage()},expandMessage:function(){this.isMessageCollapsed()&&(this.isReplyAny()&&this.set(".send",this.getSendMessage()),this.set(".collapsedMessage",!1))},getSendMessage:function(){var e=this.get(".send");if(this.isMessageCollapsed()&&this.isReplyAny()){var t=this.get(".ttype"),n=this.get(".from_mailbox");e+=this.mMessageBody.getReplyBody(t,n)}return e},isHtmlType:function(){return"html"===this.get(".ttype")},isDirty:function(){return this._isDirty},wasSendCancelled:function(){return this._cancelled},setDirty:function(e){this._isDirty=e},setSendWithoutUndo:function(){this._isIgnoreUndo=!0},markSaved:function(){this._isDirty=!1},changeRecipientsToOpposite:function(){var e=this.isReplyAll(),t={to:this.get(".to"),cc:this.get(".cc")},n=this.mMessageBody.getRecipients(e),i=this.mMessageBody.getRecipients(!e);this.set(".to",this._calculateOppositeRecipients(t.to,n.to,i.to)),this.set(".cc",this._calculateOppositeRecipients(t.cc,n.cc,i.cc))},_extractEmailsFromContacts:function(e){return _(e).pluck("email").compact().value()},_calculateOppositeRecipients:function(e,t,n){e=Jane.FormValidation.splitContacts(e),t=Jane.FormValidation.splitContacts(t),n=Jane.FormValidation.splitContacts(n);var i=this._extractEmailsFromContacts(t),r=_.filter(e,function(e){return!_.contains(i,e.email)}),s=this._extractEmailsFromContacts(r),o=_.filter(n,function(e){return!_.contains(s,e.email)});return Daria.formatContacts([].concat(r,o))},_checkData:function(){return i.a.validate(this)},storeErrors:function(e){_.each(e,function(e,t){this.setIfChanged(".errors."+t,e)},this),this.triggerFieldErrors(e)},triggerFieldErrors:function(e){this.trigger("ns-model:validation-error",e)},cleanErrors:function(){_.each(["to","cc","bcc","phone","att_ids"],function(e){this.setIfChanged(".errors."+e,"")},this)},getFieldError:function(e){return this.get(".errors."+e)},confirmations:Daria.ComposeComponents.confirmations.getConfirmations(),checkConfirmations:function(){var e=!1,t={};return _.each(this.confirmations,function(n){return!(e=n(this,t))},this),e&&this.trigger("ns-model:need-to-confirm:"+e,t),e},hasAttach:function(){return!_.isEmpty(this._attachments)||this.get(".ids").length},_getAttributeFromData:function(e,t){return _(e).pluck(t).compact().value()},_excludeFromProperty:function(e,t){return _.without(this.get("."+e),t)},addAttachment:function(e,t){this._attachments[e.info.id]=e,this._saveAttachmentData(),t&&this._savePartsJsonAttachmentData()},removeAttachment:function(e){delete this._attachments[e],this._saveAttachmentData()},addTextFromMessageBody:function(e){var t=this.get(".ttype"),n=e.getComposeHTML();"html"===t?n+="<br>":n=Daria.Html2Text.html2text(n)+"\n";var i=this.get(".send");this.set(".send",n+i)},addAttachmentsFromTemplateMessageBody:function(e){var t=ns.Model.get("compose-attachments",this.params);e.getAttachments().forEach(function(n){if(!n.inline){delete(n=_.extend({},n,{from_template:!0,template_mid:e.params.ids,template_hid:n.hid})).hid;var i=t.addAttachData(n,{mMessageBody:e,mComposeMessage:this});i.mComposeMessage.addAttachment(i,!0),t.appendAttach(i,!0)}},this)},setRecepientsFromMessageBody:function(e){var t=this;["to","cc","bcc"].forEach(function(n){var i=e.getAddressField(n);i&&t.set("."+n,i)}),this.mComposeState.set(".isCcVisible",Boolean(this.get(".cc"))),this.mComposeState.set(".isBccVisible",Boolean(this.get(".bcc")))},addForwardedMessages:function(e){if("forwarded"===this.get(".mark_as")){e=$.makeArray(e);var t=_.uniq(this.get(".mark_ids").concat(e));this.set(".mark_ids",t);var n=_.uniq(this.get(".ids").concat(e));this.set(".ids",n)}},removeForwardedMessages:function(e){if("forwarded"===this.get(".mark_as")){e=$.makeArray(e);var t=_.difference(this.get(".mark_ids"),e);this.set(".mark_ids",t);var n=_.difference(this.get(".ids"),e);this.set(".ids",n)}},_saveAttachmentData:function(){var e=_.map(this._attachments,function(e){return Object(o.a)(e.info,e.status)});this.set(".att_ids",this._getAttributeFromData(e,"att_id")),this.set(".parts",this._getAttributeFromData(e,"hid"));var t=this._getAttributeFromData(e,"disk"),n=t.length?JSON.stringify(t):"";this.set(".disk_att",n)},_savePartsJsonAttachmentData:function(){var e=_.map(this._attachments,function(e){return Object(o.a)(e.info,e.status)});this.set(".parts_json",this._getPartsJsonFromAttachmentData(e))},_getPartsJsonFromAttachmentData:function(e){var t=_.filter(e,"from_template").map(function(e){return{mid:e.template_mid,hid:e.template_hid}});return t.length>0?JSON.stringify(t):""},_getCommonSendParams:function(){var e={};return ns.request.addRequestParams(e),e},_updateDataAfterSave:function(e){this.set(".ign_overwrite","no"),e.storedmid&&this.set(".overwrite",e.storedmid),e.store_fid&&this.set(".current_folder",e.store_fid),this.composeParamsService.data=this.data},_processSaveResponse:function(e){var t,n=e.storedmid||this.getDraftMid();if(n&&this.mMessage){t=this.mMessage.get(".mid");var i=ns.Model.get("message-draft",{ids:this.mMessage.params.ids});i.isValid()&&i.setIfChanged(".mid",n)}if(!e.storedmid||this.inNotInitedState())return this.isDraft()?e.storedmid?this._syncService.updateDraftAfterAction(!0,e.storedmid):this._syncService.updateFolders(l.DraftLikeFoldersShort):this.isTemplate()&&this._syncService.updateFolders(l.DraftTemplateLikeFoldersShort),vow.Promise.reject(e.storedmid?"no response mid":"leave compose");if(this._updateDataAfterSave(e),this.isDraft())this._syncService.updateDraftAfterAction(!0,this.getDraftMid());else if(this.isTemplate()){this._syncService.updateTemplateAfterAction(this.getTemplateMid());var r=this.getTemplateMid();ns.events.trigger("daria:mComposeMessage:template-saved",{oldMid:t,mid:r})}return this.markSaved(),this.trigger("ns-model:draft-saved",{mid:e.storedmid,attachments:e.attachment}),e},_processSendResponse:function(e){var t=no.jpath(".limited.recipient",e);t&&this.set(".limited",this._parseLimited(t));var n=no.jpath(".message_id",e);n&&this.set(".sentMessageId",n);var i=no.jpath(".storedmid",e);i&&this.set(".sentMid",i),this._syncService.updateDraftAfterAction(!1,this.getDraftMid()),this._syncService.updateMessageFlagsAfterSend(this.get(".mark_ids"),{isForward:this.isForward(),isReply:this.isReplyAny(),replyMessageId:this.get(".inreplyto")})},_parseLimited:function(t){var n=[],i=[],r={},s=function(e,t){n.push(t.limit),i.push("<"+t.login+"@"+t.$t+">")};return $.isArray(t)?($.each(t,s),n.sort(),r.recipients=i.join(e)):(s(0,t),r.recipient=i[0]),r.limit=Jane.getHumanSize(n[0]),r},isTemplate:function(){return this.composeParamsService.isTemplate()},isNewMessage:function(){return!this.params.ids},isForward:function(){return this.composeParamsService.isForward()},isReplyAll:function(){return this.composeParamsService.isReplyAll()},isReply:function(){return this.composeParamsService.isReply()},isReplyAny:function(){return this.composeParamsService.isReplyAny()},isNewTemplate:function(){var e=!1;return this.mMessage||this.get(".save_symbol")!==l.WellKnownFolderSymbol.TEMPLATE||(e=!0),e},isAutosaveEnabled:function(){return!this.isTemplate()&&this.mSettings.isSet("enable_autosave")},withUndo:function(){var e=Daria.SendMail.getUndoSendTime();return!this._isIgnoreUndo&&e>0},_prepareDataForMailSend:function(e,t){if((e=_.omit(e,["errors","recipients-diff"])).current_time=Math.floor(Daria.now()/1e3),t?(e.lids=_.filter(e.lids,_.negate(this._systemLabelFilter),this),e.remind_period=null,e.send_time=null):(this.isTemplate()&&(e.ign_overwrite="yes"),this.withUndo()&&!this.isDelayed()&&(e.send_time=Daria.SendMail.getUndoSendTime(),e.relative=!0)),Daria.IS_CORP&&!this.mComposeState.get(".recipients-diff-pane-close")){var n="",i=this._getRecipientsDiffStr();i.length>0&&(n=this.isHtmlType()?Daria.Html2Text.text2html(i)+"<div>&nbsp;</div>":i+"\n\n",e.send=n+e.send)}return e},createTemplateFolder:function(){var e=ns.Model.get("folders"),t=e.getFidBySymbol(l.WellKnownFolderSymbol.TEMPLATE),n=vow.Promise.resolve();return t?this.set(".templates_fid",t):n=e.createTemplateFolder().then(function(e){return this.set(".templates_fid",e.fid),e},this),n},save:function(e){var t=this;return this._saveDraftPromise=this._save(e).always(function(e){return t._saveDraftPromise=null,e}),this._saveDraftPromise},_save:function(e){e=e||{};var t=vow.Promise.resolve();if(!e.force&&!this.isDirty())return t;this.isTemplate()&&(t=this.createTemplateFolder());var n=this.getData(),i=this._getCommonSendParams(),r=_.extend({},n,i,{nosend:"yes"});(r=this._prepareDataForMailSend(r,!0)).send=this.getSendMessage();var s=t.then(this.makeRequest.bind(this,r,"_save=true","save")),o=s.then(this._processSaveResponse,this);return e.httpResponse?s:o},waitForDraftSave:function(){return this._saveDraftPromise?this._saveDraftPromise.always(function(){return vow.resolve()}):vow.resolve()},makeRequest:function(e,t,n){var i=this;if(this._cancelled)return vow.reject("send-cancelled");var r=this;return this.isTemplate()&&!e.templates_fid&&(e.templates_fid=this.get(".templates_fid")),new vow.Promise(function(s,o){i._cancelSendCallback=function(){Jane.ErrorLog.send({errorType:"cancel_send_while_sending",overwriteMid:e.overwrite})},e._eexp=Daria.Config["eexp-boxes"],$.ajax({url:Daria.api["do-send"]+"?"+t,method:"POST",dataType:"json",cache:!1,data:e,success:function(t,i,a){if(Daria.parseLoginInfo(t)){r.onXHRSuccess(t,s,o,n);var u=r.isDelayed()&&!e.relative;r._cancelIfNeeded(t,u)}else r.onXHRError(a,"no_auth",o,n)},error:function(e,t){r.onXHRError(e,t,o,n)},complete:function(){r._cancelSendCallback=null}})})},_cancelIfNeeded:function(e,t){var n=no.jpath(".storedmid",e);n&&this._cancelled&&Daria.SendMail.cancelSendMessage(n,"sending_message",t)},_waitForAttachmentsUploaded:function(){var e=this;return this._cancelled?vow.reject("send-cancelled"):new vow.Promise(function(t,n){e._cancelSendCallback=n;var i=ns.Model.get("compose-attachments",e.params);i.isValid()&&i.isUploading()?(ns.events.once("attachments.all-uploaded",t),i.once("ns-model:attachments.failed",function(){e._checkData().fail(function(t){e.storeErrors(t),n("attachments-failed")})})):t()})},_preSend:function(e){var t=this;return this._cancelled=!1,this.cleanErrors(),new vow.Promise(function(n,i){t._cancelSendCallback=i,t._checkData().fail(function(e){return t.storeErrors(e),vow.reject("message-not-valid")}).then(function(){if(t._cancelled)return vow.reject("send-cancelled");if(!e.force&&t.checkConfirmations())return vow.reject("need-confirm");var n={};if(t.withUndo()){var i=Daria.SendMail.getUndoSendLogger(t.params.ids);i.logShow(),n.onClose=function(){i.logClose()},n.onCancel=function(){i.logCancel(),t._cancelled=!0,t._cancelSendCallback&&(t._cancelSendCallback("send-cancelled"),t._cancelSendCallback=null)}}return Daria.SendMail.showSendingMessage(n),t.trigger("ns-model:store-subject-for-autocomplete"),t._waitForAttachmentsUploaded()}).then(n,i)})},_send:function(){var e=this;if(this._cancelled)return vow.reject("send-cancelled");var t=this.getData(),n=this._getCommonSendParams(),i=_.extend({},t,n);return i.send=this.getSendMessage(),i=this._prepareDataForMailSend(i,!1),this._draftMid=this.getDraftMid(),ns.Model.get("message-failed").setMid(this._draftMid),new vow.Promise(function(t,n){e._cancelSendCallback=n,e.makeRequest(i,"_send=true","send").then(e._processSendResponse,e).then(t,n)})},send:function(e){var t=this;e=e||{};var n=Daria.SendMail.getUndoSendLogger(this.params.ids);return n.logActionOnceAfterCancel("click_send"),n.cancelled=!1,n.resetStartTime(),this._preSend(e).then(this._send,this).always(function(e){return t._cancelled&&t._draftMid&&(ns.Model.get("message-failed").removeMid(t._draftMid),t._draftMid=null),t._cancelSendCallback=null,e})},onXHRError:function(e,t,n,i){var r,s,o=e&&e.status;"parsererror"===t?(s="bad_json",r="no_data"):"no_auth"===t?(s="NoAuth",r="no_auth"):r=413===o?"attachment_too_big":o>0?"no_data":"http_status_0",s=s||r,Jane.ErrorLog.send({errorType:"compose.http",status:s},e.responseText),"NoAuth"!==s&&this.onSendError(r,n,i)},onXHRSuccess:function(e,t,n,i){var r=jpath(e,".limited.recipient")[0],s=Array.isArray(r)&&r.length?"ok":jpath(e,".status")[0];switch(s){case"ok":t(e);break;case"captcha_request":e.captcha_key&&ns.Model.get("captcha").setData({key:e.captcha_key,url:e.captcha_url,_:e.captcha_key}),this.trigger("ns-model:captcha-request"),this.onSendError(s,n,i);break;case c.SendError.UNDO_MESSAGE_SAVED:case c.SendError.DELAYED_MESSAGE_SAVED:this._updateDataAfterSave(e),this.onSendError(s,n,i);break;default:this.onSendError(s,n,i)}},onSendError:function(e,t,n){e=e||"internal_error",Jane.ErrorLog.send({errorType:"compose."+n+".failed",status:e}),ns.Model.get("message-failed").removeMid(this.getDraftMid()),t(e)},isSystemLabel:function(e){var t=Object(d.a)(),n=ns.Model.get("labels",{mailboxUid:t}),i=n.getLabelById(e);if(!i)return!1;if(i.user)return!1;var r=n.getWaitingForReplyLabel(),s=n.getDelayedMessageLabel();return _.contains([r,s],i)},getLabelsHash:function(){var e=Object(d.a)(),t=ns.Model.get("labels",{mailboxUid:e}).getLabelsHash(),n=this.get(".lids")||[];return _.each(n,function(e){t[e]=1}),t},addLid:function(e){e=$.makeArray(e);var t=this.get(".lids")||[];if((e=_.difference(e,t)).length){t=t.concat(e);var n=_.all(e,this._systemLabelFilter,this);this.set(".lids",t,{silent:n})}},removeLid:function(e){e=$.makeArray(e);var t=this.get(".lids");t&&t.length&&((t=_.difference(t,e)).length?this.set(".lids",t,{silent:this.isSystemLabel(e)}):(this.set(".lids",[]),delete this.getData().lids))},hasUserLabels:function(){return!_(this.get(".lids")).filter(this._userLabelFilter,this).isEmpty()},getUserLabels:function(){return _(this.get(".lids")).filter(this._userLabelFilter,this).value()},_userLabelFilter:function(e){var t=ns.Model.get("labels"),n=t.getLabelById(e),i=t.getImportantLID();return n&&(n.user||e===i)&&!this.isSystemLabel(e)},_systemLabelFilter:function(e){return this.isSystemLabel(e)},getFromEmails:function(){var e=String(this.get(".from_mailbox")||"");return _.map(ns.Model.get("account-information").getFromEmails(),function(t){return{text:t,value:t,selected:e.toLowerCase()===t.toLowerCase()}})},getLanguage:function(){var e="ru";if(this.isReply()){var t=this.params.ids;if(!(e=Daria.Translate.getLangByMid(t))){var n=this.mMessageBody.getComposeHTML();e=Daria.Translate.defineLanguage(n)}}else{var i=this.get(".send");_.trim(i.replace(/\&nbsp;/gi,"")).length?e=Daria.Translate.defineLanguage(i):_.contains(Daria.Translate.langs.all.s,Daria.Config.locale)&&(e=Daria.Config.locale)}return e},formatContacts:function(e,t){var n=this.get("."+e);return Jane.FormValidation.splitContacts(n).map(function(n){return n.type=e,n.ref=t.getEmailRef(n.email),n},this)},getContacts:function(e){var t=this.get("."+e);return"phone"===e?Jane.FormValidation.splitPhones(t):Jane.FormValidation.splitContacts(t)},getAllRecepients:function(){var e=this.getContacts("to"),t=this.getContacts("cc"),n=this.getContacts("bcc");return Array.prototype.concat.call(e,t,n)},getAllRecepientEmails:function(){return{to:this._extractEmailsFromContacts(this.getContacts("to")),cc:this._extractEmailsFromContacts(this.getContacts("cc")),bcc:this._extractEmailsFromContacts(this.getContacts("bcc"))}},setContacts:function(t,n){var i="."+t;this.set(i,_.map(n,function(e){return Jane.FormValidation.obj2contact(e)}).join(e)+",")},appendContact:function(e,t){t&&this.setContacts(e,this.getContacts(e).concat(t))},isDelayed:function(){return Boolean(this.get(".send_time"))},resetDelayed:function(){this.setIfChanged(".send_time",null)},getPassportSendDate:function(){var e=Jane.Date.parseCalendarDate(this.get(".send_time"));return e?Daria.getPassportDate(e):void 0},_getArrayOfEmails:function(e){return e.map(function(e){return e.email})},_onRecipientsChanged:function(){if(!Daria.IS_CORP)return vow.resolve();if(this.isTemplate()||this.isNewMessage()||this.isForward())return vow.resolve();if(!this.get(".initial_to")&&!this.get(".initial_cc"))return vow.resolve();var e=this;return vow.resolve().then(function(){var t=_.union(Jane.FormValidation.splitContacts(e.get(".initial_to")||""),Jane.FormValidation.splitContacts(e.get(".initial_cc")||"")),n=_.union(Jane.FormValidation.splitContacts(e.get(".to")||""),Jane.FormValidation.splitContacts(e.get(".cc")||"")),i=_.uniq(e._getArrayOfEmails(t)),r=_.uniq(e._getArrayOfEmails(n)),s=_.difference(r,i).sort(),o=_.difference(i,r);return i.length-o.length<2&&o.length>0?i.length-o.length==1?ns.Model.get("get-maillists-static").getMaillists(r).then(function(e){return 0===e.length&&(o=[i18n("%All")]),{removed:o,added:s}}).fail(function(e){throw e}):{removed:o=[i18n("%All")],added:s}:{removed:o,added:s}}).then(function(t){e.set(".recipients-diff",{added:t.added,removed:t.removed})}).fail(function(e){throw e})},_getRecipientsDiffStr:function(){var t=this.get(".recipients-diff"),n=[];return 0===t.added.length&&0===t.removed.length?n=[]:(t.added.length>0&&n.push("+ "+t.added.join(e)),t.removed.length>0&&n.push("- "+t.removed.join(e))),n.join("\n")},hasOnlyOneValidRecipient:function(e){var t=(e=["to","cc","bcc"].indexOf(e)>-1?e:"")?this.getContacts(e):this.getAllRecepients();return Array.isArray(t)&&1===t.length&&Jane.FormValidation.checkEmail(t[0].email||"")}}})}()},2989:function(e,t,n){"use strict";var i=function(e){return function(e){var t=Jane.FormValidation.splitContacts(e);return Daria.Recipients.requestContacts(t).always(function(){return t.filter(function(e){return!Jane.FormValidation.checkEmail(e.email)})})}(e).then(function(e){if(!e.length)return vow.resolve();var t=e.map(function(e){return e.name?"".concat(e.email," (").concat(e.name,")"):e.email}).join(", ");return vow.reject("".concat(i18n("%Compose_Error_Invalid_Emails")," ").concat(t))})},r={to:[function(e,t){return new vow.Promise(function(n,i){e||t.get(".cc")||t.get(".bcc")?n():i(i18n("%Compose_Email_Required"))})},i],phone:[function(e){return new vow.Promise(function(t,n){e&&!Jane.FormValidation.checkPhoneNumber(e)?n(i18n("%ValidatePhoneError_badnumformat")):t()})}],cc:[i],bcc:[i],att_ids:[function(e,t){return new vow.Promise(function(e,n){var i=ns.Model.get("compose-attachments",t.params);i.isValid()&&i.isFailed()?n(i18n("%Compose_Attachment_Failed")):e()})}]};t.a={validate:function(e){return new vow.Promise(function(t,n){var i=e.getData(),s={},o=!0;vow.all(Object.keys(i).map(function(t){var n=i[t];return vow.all((r[t]||[]).map(function(i){return i(n,e).fail(function(e){s[t]=s[t]||e,o=!1})}))})).always(function(){o?t():n(s)})})}}},2990:function(e,t){!function(){var e={editorMode:"",editorMaximize:2,messageHeight:190,bodyPos:0,editorBookmark:null,isCcVisible:!1,isBccVisible:!1,isReplyAllNoticeVisible:!1,isPhoneVisible:!1,isPhoneEnabled:!1,isOpenedWithToolbarAttachPopup:!1,saveTemplateAndLeave:!1,saveTemplateAndReset:!1,submitButtonText:i18n("%Отправить"),activeActionButtonView:"compose-send-link",focusField:"to",waitSuggest:!1,formRect:null,"recipients-diff-pane-close":!1,visibleNotices:{to:[],phone:[],cc:[],bcc:[]},translationEnabled:!1},t=ns.Model.prototype;ns.Model.define("compose-state",{events:{"ns-model-before-destroyed":"onBeforeDestroyed"},params:{ids:null,tids:null,oper:null},ctor:function(){this._onComposeMessageFieldChanged=this._onComposeMessageFieldChanged.bind(this),this._refreshSubmitButtonText=this._refreshSubmitButtonText.bind(this)},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this._mComposeMessage||this._mComposeMessage.canRequest();return e&&t},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){var e=[{id:"compose-message",params:this.params}];return this.params.ids&&_.isString(this.params.ids)&&!this.params.tids&&e.push({id:"message-body",params:ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params)}),e},_initFromModels:function(t){this.mComposeMessage=_.find(t,"id","compose-message"),this.mMessageBody=_.find(t,"id","message-body"),this._bindModelEvents();var n="reply"===this.params.oper&&this.mMessageBody&&this.mMessageBody.allowedReplyAll();this.setData(_.extend({},e,{isReplyAllNoticeVisible:n,isCcVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".cc")),isBccVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".bcc")),isPhoneVisible:Boolean(this.mComposeMessage&&this.mComposeMessage.get(".phone")),focusField:this.mComposeMessage.isReplyAny()?"send":e.focusField})),this._refreshSubmitButtonText()},onBeforeDestroyed:function(){this._unbindModelEvents()},_bindModelEvents:function(){this.on("ns-model-changed.translationEnabled",this._refreshSubmitButtonText),this.mComposeMessage&&(this.mComposeMessage.on("ns-model-changed.send_time",this._refreshSubmitButtonText),_.each(["to","phone","cc","bcc"],function(e){this.mComposeMessage.on("ns-model-changed."+e,this._onComposeMessageFieldChanged)},this))},_unbindModelEvents:function(){this.mComposeMessage&&(this.mComposeMessage.off("ns-model-changed.send_time",this._refreshSubmitButtonText),_.each(["to","phone","cc","bcc"],function(e){this.mComposeMessage.off("ns-model-changed."+e,this._onComposeMessageFieldChanged)},this))},_isNdaNoticeNeeded:function(e){if(Daria.IS_CORP)return!1;var t=this.mComposeMessage.getContacts(e),n=!1,i=!1;return _(t).pluck("email").each(function(e){Jane.FormValidation.checkExternalEmail(e)?i=!0:n=!0}).value(),n&&i},_onComposeMessageFieldChanged:function(e,t){var n=t.substr(1),i={nda:this._isNdaNoticeNeeded.bind(this,n)},r=this.get(".visibleNotices."+n);_.each(i,function(e,t){r=e()?_.uniq(r.concat(t)):_.without(r,t)}),this.setIfChanged(".visibleNotices."+n,r)},setFocusField:function(e,t){this.set(".focusField",e,t)},getFocusField:function(){return this.get(".focusField")},setWaitSuggest:function(e,t){this.set(".waitSuggest",e,t)},getWaitSuggest:function(){return this.get(".waitSuggest")},set:function(e,n,i){i||(i={});var r=this.get(e);_.isEqual(r,n)&&!i.force||t.set.call(this,e,n,i)},setMessageHeight:function(e){e<190&&(e=190),this.set(".messageHeight",e)},hasSpellingCheck:function(){return"TUR"!==Daria.Config.product&&!_.contains(["ka","hy","ro"],Daria.Config.locale)},hasEnSpellingCheckIcon:function(){return!_.contains(["ru","uk","be"],Daria.Config.locale)},hasDisk:function(){return _.contains(Daria.SIDS,"59")},isFieldEnabled:function(e){return!_.contains(["phone"],e)||this.get(".is"+_.capitalize(e)+"Enabled")},isFieldVisible:function(e){return!_.contains(["phone","cc","bcc"],e)||this.get(".is"+_.capitalize(e)+"Visible")},isCcVisible:function(){return this.get(".isCcVisible")},isBccVisible:function(){return this.get(".isBccVisible")},isPhoneVisible:function(){return this.get(".isPhoneVisible")},isReplyAllNoticeVisible:function(e){return"to"===e&&this.get(".isReplyAllNoticeVisible")},isNdaNoticeVisible:function(e){return Daria.IS_CORP&&_.contains(this.get(".visibleNotices."+e),"nda")},setLastSaveTime:function(){this.set(".lastSaveTime",Jane.Date.format("%R",Daria.now()))},isMinWidth:function(){var e=ns.Model.get("settings"),t=Number(e.getSetting("size-view-app")),n=Number(e.getSetting("size-layout-left")),i=Daria.resize.elements.leftPane.params.maxWidth;return 1024===t&&n===i},getSubmitButtonText:function(){var e=this.get(".translationEnabled"),t=this.mComposeMessage.getPassportSendDate();if(t){var n=Jane.Date.toHumanFormat(t),i=Jane.Date.format("%Date_HM__colon",t);return e?i18n("%Compose_Translate_Send_With_Deferred_Option",n,i):i18n("%Compose_Send_With_Deferred_Option",n,i)}return e?i18n("%Compose_Translate_Send"):i18n("%Отправить")},_refreshSubmitButtonText:function(){this.setIfChanged(".submitButtonText",this.getSubmitButtonText())}}})}()},2991:function(e,t){ns.Model.define("compose-forwarded-messages",{params:{ids:null,tids:null,oper:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this.mComposeMessage||this.mComposeMessage.canRequest();return e&&t},request:function(){return this.mComposeMessage=ns.Model.get("compose-message",_.clone(this.params)),ns.request([this.mComposeMessage]).then(function(){this.setData([]),ns.request(this._constructModelRequest()).then(this._initFromModels,this)},null,this)},_constructModelRequest:function(){var e=[];if("forward"!==this.params.oper)return e;var t=$.makeArray(this.params.tids),n=$.makeArray(this.params.ids);return e=(e=e.concat(_.map(t,function(e){return{id:"messages",params:{thread_id:e,first:0,count:ns.Model.get("message",{ids:e}).getThreadCount()||500}}}))).concat(_.map(n,function(e){return{id:"message",params:{ids:e}}}))},_initFromModels:function(e){var t=[];_.each(e,function(e){switch(e.id){case"messages":t.push.apply(t,e.models);break;case"message":t.push(e)}}),this._setMessages(t)},_setMessages:function(e){var t=!1;e.length>1&&(t=!0);var n=_.map(e,function(e){return{mid:e.get(".mid"),subject:e.get(".subject"),checked:t,link:e.getMessageLink()}});this.setData(n),t&&this.mComposeMessage.addForwardedMessages(_.pluck(n,"mid"))},checkMessage:function(e){_.find(this.getData(),{mid:e}).checked=!0,this.mComposeMessage.addForwardedMessages(e)},uncheckMessage:function(e){_.find(this.getData(),{mid:e}).checked=!1,this.mComposeMessage.removeForwardedMessages(e)},getMessagesIds:function(){return this.getData().filter(function(e){return e.checked}).map(function(e){return e.mid})}}})},2992:function(e,t){ns.Model.define("compose-fsm",{params:{ids:null,oper:null},methods:{start:"edit",transitions:{save:["edit","sending","cancel"],edit:["save","sending","cancel"],sending:["edit","sent"],cancel:["edit"]},canAutosave:function(){return this._checkTransitionToState("save")}}},ns.ModelFsm)},2993:function(e,t){ns.Model.define("compose-signature",{params:{ids:null,tids:null,oper:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=!this.mComposeMessage||this.mComposeMessage.canRequest();return e&&t},request:function(){var e=this._constructModelRequest();return ns.request(e).then(this._initFromModels,this)},_constructModelRequest:function(){return[{id:"settings"},{id:"compose-message",params:_.clone(this.params)}]},_initFromModels:function(e){this.mSettings=e[0],this.mComposeMessage=e[1],this.setData({signature:""})},getSignatureList:function(){var e=this.mComposeMessage.get(".from_mailbox"),t=this.mComposeMessage.getLanguage(),n={mode:this.mComposeMessage.get(".ttype"),signs:[]};switch(n.mode){case"html":n.signs=Daria.signs.getHtml();break;case"plain":n.signs=Daria.signs.getPlain()}var i=Daria.signs.getFilteredSigns(n.signs,e);return 0===i.length?n.noSuitableSignature=!0:i.sort(Daria.signs.sort(e,t)),n.signs=_.uniq([].concat(i,n.signs)),n},hasSignatureControl:function(){return!Daria.Config.NO_SETTINGS&&!Modernizr.ios}}})},2994:function(e,t){ns.Model.define("do-cancel-send-delayed",{params:{ids:null}})},2995:function(e,t){ns.Model.define("do-cancel-send-undo",{params:{ids:null,mailboxUid:null}})},2996:function(e,t){function n(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}ns.Model.define("compose-popular-contacts",{events:{},params:{ids:null,oper:null,count:null},methods:{canRequest:function(){var e=this.super_.canRequest.call(this),t=ns.Model.get("compose-message",this.params),n=!t||t.canRequest();return e&&n},request:function(){var e=this._constructModelRequest();return ns.request(e).then(function(e){var t=_.zipObject(_.pluck(e,"id"),e);this._initFromModels(t)},this)},_constructModelRequest:function(){return[{id:"abook-suggest",params:{q:"",popular:!0,climit:this.params.count}},{id:"compose-message",params:this.params},{id:"index-data"}]},_initFromModels:function(e){var t=e["abook-suggest"],i=e["compose-message"],r=e["index-data"].get(".email"),s=i.getAllRecepients(),o=_.filter(t.get(".contacts"),function(e){return e.email!==r}),a={name:i18n("%Compose_Send_it_to_me"),email:r},u=_.map([a].concat(n(o)),function(e){return e.name||(e.name=e.email),e.phone=_.get(e,["phones",0]),_.extend({},e,{used:_.any(s,{email:e.email})})},this);this.setData(u)},getContact:function(e){return _.find(this.getData(),e)},actualizeUsedContacts:function(e){_.each(this.getData(),function(t){t.used=_.any(e,{email:t.email})})},isAnyUnusedContact:function(){return!this.isValid()||_.any(this.getData(),function(e){return!e.used})},getUnusedContacts:function(){return _.filter(this.getData(),function(e){return!e.used})},clean:function(){_.each(this.getData(),function(e){e.used=!1})}}})},2997:function(e,t){ns.Model.define("compose-field-notice",{events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null,type:null},methods:{_onInit:function(){this.setData({type:null})}}},ns.ModelStatic),ns.Model.define("compose-field-extras",{events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null,type:null},methods:{_onInit:function(){this.setData({type:null})}}},ns.ModelStatic)},2998:function(e,t){ns.Model.define("compose-field-notices",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null},methods:{_onInit:function(){this.setData({})}}},ns.ModelCollectionStatic),ns.Model.define("compose-field-extras-collection",{isCollection:!0,events:{"ns-model-init":"_onInit"},params:{ids:null,oper:null,field:null},methods:{_onInit:function(){this.setData({})}}},ns.ModelCollectionStatic)},2999:function(e,t){ns.Model.define("compose-emoticons",{events:{"ns-model-init":"_onInit"},params:{},methods:{_onInit:function(){this.setData({items:[{suid:21,name:"Улыбается"},{suid:22,name:"Подмигивает"},{suid:23,name:"Показывает язык"},{suid:24,name:"Благодарит"},{suid:25,name:"Крутой"},{suid:26,name:"Удивляется"},{suid:27,name:"Огорчается"},{suid:28,name:"Обижается"},{suid:29,name:"Плачет"},{suid:30,name:"Зевает"},{suid:31,name:"Смущается"},{suid:32,name:"Не может сказать вслух"},{suid:33,name:"Не в себе"},{suid:34,name:"Сумасшедший"},{suid:35,name:"Ехидный"},{suid:36,name:"Ангелочек"},{suid:37,name:"Влюбленный"},{suid:38,name:"Сердце разбито"},{suid:45,name:"Отдых"},{suid:51,name:"Подарок"},{suid:40,name:"Мокро"},{suid:43,name:"Дождь"},{suid:46,name:"Солнечно"},{suid:47,name:"Холодно"},{suid:50,name:"Планета"},{suid:42,name:"Не одобряю"},{suid:41,name:"Одобряю"},{suid:48,name:"Бомба"},{suid:49,name:"Идея!"},{suid:44,name:"Музыка"}]})}}},ns.ModelStatic)},3000:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2);n.n(i);function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],i=!0,r=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(i=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(e){r=!0,s=e}finally{try{i||null==a.return||a.return()}finally{if(r)throw s}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var s=function(){};ns.Model.define("compose-autocomplete",{params:{text:null,id:null,text_limit:null,message_id:null,thread_id:null,init_session:null,extra_params:null,allow_pers_data:null},ctor:function(){this._failedRequests=0},methods:{MAX_FAILED_REQUESTS:3,_getTextLimit:function(){return 4096},canRequest:function(){return this.retries<1},getItemsData:function(e){var t=this,n=e,r=this._getTextLimit();return n.length>r&&(n=n.slice(n.length-r)),vow.Promise.resolve().then(function(){return t._requestItemsData(n)}).then(function(e){var n=e.items,i=e.requestId;return t.setData({items:n,autocompleteRequestId:i}),t.getData()}).catch(function(e){return Jane.ErrorLog.log({type:i.ErrorType.NsModel,source:i.ErrorSource.Request,sourceMethod:t.id,block:i.ErrorBlock.Compose,method:"getItemsData"},e)})},initSession:function(){return ns.forcedRequest(this.id,{id:this.params.id,thread_id:this.params.thread_id,init_session:!0,message_id:this.params.message_id}).then(s).fail(s)},request:function(){var e=this;return ns.request.fetchModels([this]).then(function(t){if(!1===ns.request.canProcessResponse(t))return Vow.reject({error:"CANT_PROCESS",invalid:[e],valid:[]});ns.request.extractModel(e,t.models[0],t)},function(t){var n=t.error;ns.request.extractModel(e,{error:n})})},setError:function(e){var t=ns.key("model=".concat(this.id),this._getParamsForLog());ns.Model.prototype.setError.apply(this,[e,t])},_requestItemsData:function(e){var t=this;return vow.Promise.resolve().then(function(){return t._failedRequests>=t.MAX_FAILED_REQUESTS?{items:[],requestId:""}:ns.forcedRequest(t.id,{id:t.params.id,text:e,text_limit:t._getTextLimit(),thread_id:t.params.thread_id,message_id:t.params.message_id,allow_pers_data:t._getPersonalDataSetting()}).then(function(e){var n=r(e,1)[0];t._failedRequests=0;var i=n.get(".items"),s=n.get(".autocompleteRequestId");return n.destroy(),{items:i,requestId:s}}).fail(function(){return++t._failedRequests,{items:[],requestId:""}})})},_getPersonalDataSetting:function(){return ns.Model.get("settings").getSign("allow_pers_data_autocomplete")?"on":""},_getParamsForLog:function(){var e=this.params.text;return{text_length:e?e.length:0,id:this.params.id,thread_id:this.params.thread_id,text_limit:this.params.text_limit}}}})},3001:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(2);n.n(i);function r(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(!(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)))return;var n=[],i=!0,r=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(i=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(e){r=!0,s=e}finally{try{i||null==a.return||a.return()}finally{if(r)throw s}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function s(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter(function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable})),n.push.apply(n,i)}return n}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=20480,u=100,c=100,l=1;ns.Model.define("compose-smartsubject",{params:{id:null,position:null,message_id:null,thread_id:null,text:null,to:null,cc:null,bcc:null,from:null,attaches:null,extra_params:null},ctor:function(){this._failedRequests=0},methods:{MAX_FAILED_REQUESTS:3,canRequest:function(){return this.retries<1},getItemsData:function(e){var t=this,n=e.text,r=e.addresses,s=e.attaches;return vow.Promise.resolve().then(function(){return t._requestItemsData({text:n,addresses:r,attaches:s})}).then(function(e){var n=e.items,i=e.requestId;return t.setData({items:n,requestId:i}),t.getData()}).catch(function(e){return Jane.ErrorLog.log({type:i.ErrorType.NsModel,source:i.ErrorSource.Request,sourceMethod:t.id,block:i.ErrorBlock.Compose,sessionId:t.id,method:"getItemsData"},e)})},request:function(){var e=this;return ns.request.fetchModels([this]).then(function(t){if(!1===ns.request.canProcessResponse(t))return Vow.reject({error:"CANT_PROCESS",invalid:[e],valid:[]});ns.request.extractModel(e,t.models[0],t)},function(t){var n=t.error;ns.request.extractModel(e,{error:n})})},setError:function(e){var t=ns.key("model=".concat(this.id),this._getParamsForLog());ns.Model.prototype.setError.apply(this,[e,t])},_requestItemsData:function(e){var t=this,n=e.text,i=e.addresses,u=e.attaches;return vow.Promise.resolve().then(function(){if(t._failedRequests>=t.MAX_FAILED_REQUESTS)return{items:[],requestId:""};var e="ssreq-".concat(Daria.uid,"-").concat(t.params.message_id,"-").concat(Daria.now()).concat(l++);return ns.forcedRequest(t.id,function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?s(Object(n),!0).forEach(function(t){o(e,t,n[t])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):s(Object(n)).forEach(function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))})}return e}({},t.params,{id:e,text:(n||"").substr(0,a),to:JSON.stringify(t._limitAddresses(i.to)),cc:JSON.stringify(t._limitAddresses(i.cc)),bcc:JSON.stringify(t._limitAddresses(i.bcc)),from:JSON.stringify(i.from),attaches:JSON.stringify(t._mapAttaches(t._limitAttaches(u))),extra_params:t._getExtraParams()})).then(function(e){var n=r(e,1)[0];t._failedRequests=0;var i=n.get(".items"),s=n.get(".smartSubjectRequestId");return n.destroy(),{items:i,requestId:s}}).fail(function(){return++t._failedRequests,{items:[],requestId:""}})})},_limitAddresses:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).slice(0,u)},_limitAttaches:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).slice(0,c)},_mapAttaches:function(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).map(function(e){var t=e.info;return{id:t.id,name:t.name,mediaType:t.class}})},_getExtraParams:function(){return"exp=line_popup_final&chain=prod"},_getParamsForLog:function(){return{text_length:(this.params.text||"").length,id:this.params.id,message_id:this.params.message_id,thread_id:this.params.thread_id,recipients_length:(this.params.to||[]).length+(this.params.cc||[]).length+(this.params.bcc||[]).length,from:this.params.from,attaches_length:(this.params.attaches||[]).length}}}})},3002:function(e,t){!function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={exports:{},id:i,loaded:!1};return e[i].call(r.exports,r,r.exports,n),r.loaded=!0,r.exports}n.m=e,n.c=t,n.p="",n(0)}([function(e,t,n){function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function r(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t&&s(e.prototype,t),n&&s(e,n),e}function a(e){var t="function"==typeof Map?new Map:void 0;return(a=function(e){if(null===e||!function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return u(e,arguments,l(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),c(n,e)})(e)}function u(e,t,n){return(u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}()?Reflect.construct:function(e,t,n){var i=[null];i.push.apply(i,t);var r=new(Function.bind.apply(e,i));return n&&c(r,n.prototype),r}).apply(null,arguments)}function c(e,t){return(c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var d=n(1),f=n(2),h=n(6),m=n(38),g=function(e){function t(){var e,n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var i=arguments.length,s=new Array(i),o=0;o<i;o++)s[o]=arguments[o];var a=n=r(this,(e=l(t)).call.apply(e,[this].concat(s)));return p(a),h.ready(a),r(n,a)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,a(HTMLDivElement)),o(t,null,[{key:"observedAttributes",get:function(){return m.attributes}}]),o(t,[{key:"connectedCallback",value:function(){p(this),this.editor.bubbling()}},{key:"disconnectedCallback",value:function(){!function(e){e.editor&&(f.destroy(e),delete e.editor)}(this)}},{key:"attributeChangedCallback",value:function(){m(this)}},{key:"options",value:function(e,t){return m(this,e,t)}},{key:"setContent",value:function(e){return this.editor.setContent(e)}},{key:"canAddBubble",value:function(){return this.editor.canAddBubble()}},{key:"addBubble",value:function(e,t){return this.editor.addBubble(e,t)}},{key:"removeBubble",value:function(e){return this.editor.removeBubble(e)}},{key:"editBubble",value:function(e){return this.editor.editBubble(e)}},{key:"bubbling",value:function(){return this.editor.bubbling()}},{key:"items",get:function(){return this.editor.getItems()}},{key:"inputValue",get:function(){return this.editor.inputValue()}}]),t}();function p(e){e.editor||Object.defineProperty(e,"editor",{configurable:!0,value:f.init(e)})}d.customElements.define("x-bubbles",g,{extends:"div"}),e.exports=g},function(e,t){e.exports=function(){return this||(0,eval)("this")}()},function(e,t,n){var i=n(1),r=n(3),s=n(4),o=n(13),a=n(12),u=a.EV,c=a.PROPS,l=n(5),d=n(10),f=n(6),h=n(16),m=n(14),g={blur:n(22),click:n(23),focus:n(24),keydown:n(25)},p={blur:n(26),click:n(27),mousedown:n(28),focus:n(29),keydown:n(30),keypress:n(31),keyup:n(32),paste:n(33)},_={blur:n(34),click:n(35),keydown:n(36),keypress:n(37)},v={blur:d.proxyLocal,click:d.proxyLocal,mousedown:d.proxyLocal,focus:d.proxyLocal,keydown:d.proxyLocal,keypress:d.proxyLocal,keyup:d.proxyLocal,mscontrolselect:d.prevent,paste:d.proxyLocal,resize:d.prevent,resizestart:d.prevent};function b(){var e=l.currentTextRange(this);return e&&l.textClean(e.toString())||""}function E(e){d.dispatch(this,u.BUBBLE_EDIT,{bubbles:!1,cancelable:!1,detail:{data:e}})}function y(){d.dispatch(this,u.CHANGE,{bubbles:!1,cancelable:!1})}function A(){var e=b.call(this);this[c.BUBBLE_VALUE]!==e&&(this[c.BUBBLE_VALUE]=e,d.dispatch(this,u.BUBBLE_INPUT,{bubbles:!1,cancelable:!1,detail:{data:e}}))}t.init=function(e){var t=e;return t.setAttribute("contenteditable","true"),t.setAttribute("spellcheck","false"),d.onLocal(t,g),d.onLocal(t,p),t.options("selection")&&(d.onLocal(t,_),h.init(t)),d.on(t,v),t.fireChange=f.throttle(y,t),t.fireEdit=f.throttle(E,t),t.fireInput=f.throttle(A,t),t.fireBeforeRemove=function(e){d.dispatch(this,u.BEFORE_REMOVE,{bubbles:!1,cancelable:!1,detail:{data:e}})}.bind(t),{canAddBubble:function(){return r.canAddBubble(this)}.bind(t),addBubble:function(e,t){var n=s.create(this,e,t);if(!this.canAddBubble()||!n)return!1;if(l.text2bubble(this,n))return this.fireInput(),this.fireChange(),o.restore(this),!0;return!1}.bind(t),bubbling:function(){s.bubbling(this)}.bind(t),editBubble:function(e){if(this.contains(e))return s.edit(this,e);return!1}.bind(t),getItems:function(){return r.getBubbles(this)}.bind(t),inputValue:b.bind(t),removeBubble:function(e){if(this.contains(e))return r.removeBubbles(this,[e]),this.fireChange(),!0;return!1}.bind(t),setContent:function(e){var t=i.getSelection();t&&t.removeAllRanges();var n=m.get(this);n.length&&(r.removeBubbles(this,n),this.fireChange());for(;this.firstChild;)this.removeChild(this.firstChild);return e=l.html2text(e),this.appendChild(this.ownerDocument.createTextNode(e)),s.bubbling(this),o.restore(this),!0}.bind(t)}},t.destroy=function(e){var t=e;d.off(t,v),d.offLocal(t,g),d.offLocal(t,p),t.options("selection")&&(d.offLocal(t,_),h.destroy(t))}},function(e,t,n){var i=n(4),r=n(5);function s(e){return Array.prototype.slice.call(e.querySelectorAll("[bubble]"))}function o(e){return s(e).length}function a(e){return e.nodeType===Node.ELEMENT_NODE&&"x-bubbles"===e.getAttribute("is")}function u(e){var t=e.options("limit");return t?t-o(e):Number.POSITIVE_INFINITY}t.closestNodeBubble=function(e){for(;e;){if(i.isBubbleNode(e))return e;if(a(e))return;e=e.parentNode}},t.closestNodeSet=function(e){for(;e;){if(a(e))return e;e=e.parentNode}},t.findBubbleLeft=function(e){if(!e.focusNode||!e.anchorNode)return;var t=e.focusNode.previousSibling;e.anchorNode!==e.focusNode&&e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_FOLLOWING&&(t=e.anchorNode.previousSibling);for(;t;){if(i.isBubbleNode(t))return t;if(t.nodeType===Node.TEXT_NODE&&r.textClean(t.nodeValue))return;t=t.previousSibling}},t.findBubbleRight=function(e){if(!e.focusNode||!e.anchorNode)return;var t=e.focusNode.nextSibling;e.anchorNode!==e.focusNode&&e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_FOLLOWING&&(t=e.anchorNode.nextSibling);for(;t;){if(i.isBubbleNode(t))return t;if(t.nodeType===Node.TEXT_NODE&&r.textClean(t.nodeValue))return;t=t.nextSibling}},t.getBubbles=s,t.bubblesCount=o,t.hasBubbles=function(e){return Boolean(e.querySelector("[bubble]"))},t.headBubble=function(e){return e.querySelector("[bubble]:first-child")},t.lastBubble=function(e){return e.querySelector("[bubble]:last-child")},t.nextBubble=function(e){var t=e&&e.nextSibling;for(;t;){if(i.isBubbleNode(t))return t;t=t.nextSibling}},t.prevBubble=function(e){var t=e&&e.previousSibling;for(;t;){if(i.isBubbleNode(t))return t;t=t.previousSibling}},t.removeBubbles=function(e,t){e.fireBeforeRemove(t),t.forEach(function(t){return e.removeChild(t)})},t.moveBubbles=function(e,t,n){var i=u(t);if(i<=0)return;var r=n.slice(0,i);e.fireBeforeRemove(r),r.forEach(function(e){return t.appendChild(e)})},t.canAddBubble=function(e){var t=e.options("limit");return!t||o(e)<t},t.getRemainingCapacity=u},function(e,t,n){var i=n(1),r=n(5),s=n(3),o=n(6),a=o.escape,u=o.canUseDrag;function c(e){return!(!e||e.nodeType!==Node.ELEMENT_NODE)&&e.hasAttribute("bubble")}function l(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};if(t=r.textClean(t)){var i=e.options("bubbleFormation"),s=e.options("classBubble"),o=u&&e.options("draggable")&&e.options("selection"),c=e.ownerDocument.createElement("span");for(var l in c.innerText=t,n)n[l]&&c.setAttribute("data-".concat(l),a(n[l]));if(i(c),s)for(var d=String(s).trim().split(/\s+/),f=d.length;f--;)c.classList.add(d[f]);return c.setAttribute("bubble",""),c.setAttribute("contenteditable","false"),o&&c.setAttribute("draggable","true"),c}}function d(e){return e.trim()}function f(e){return Boolean(e)}t.isBubbleNode=c,t.bubbling=function(e){var t=e.options("begining"),n=e.options("ending"),o=e.options("separator"),a=e.options("tokenizer"),u=function(e){for(var t,n,r=[],s=e.childNodes,o=0;o<s.length;o++)c(n=s[o])?t&&(t.setEndBefore(n),r.push(t),t=void 0):t||(t=i.document.createRange()).setStartBefore(n);t&&(t.setEndAfter(n),r.push(t));return r}(e),h=[],m=s.getRemainingCapacity(e);u.forEach(function(s){var u=r.textClean(s.toString());if(u){var c=[u];if(a?c=a(u):(o&&(c=u.split(o).map(d).filter(f)),n?c=c.reduce(function(e,t){return e.concat(function(e,t){var n=[],i=0,r=999;for(t.lastIndex=0;null!==t.exec(e)&&r;)r--,n.push(e.substring(i,t.lastIndex)),i=t.lastIndex;return n}(t,n))},[]).map(d).filter(f):t&&(c=c.reduce(function(e,n){return e.concat(function(e,t){var n,i=[],r=0,s=999;for(t.lastIndex=0;null!==(n=t.exec(e))&&s;)s--,r!==n.index&&(i.push(e.substring(r,n.index)),r=n.index);return i.push(e.substring(r,e.length)),i}(n,t))},[]).map(d).filter(f))),Array.isArray(c)&&c.length){var g=i.document.createDocumentFragment();c.forEach(function(t){if(!(h.length>=m)){var n=l(e,t);n&&(g.appendChild(n),h.push(n))}}),s.deleteContents(),s.insertNode(g)}else s.deleteContents()}else s.deleteContents()}),e.fireInput(),h.length&&e.fireChange();return h},t.create=l,t.edit=function(e,t){if(t.hasAttribute("readonly"))return!1;var n=i.getSelection();if(!n)return!1;var s=e.options("bubbleDeformation")(t);if(!s){var o=r.textClean(t.innerText);s={text:o,startOffset:0,endOffset:o.length}}var a=r.createZws(),u=i.document.createTextNode(s.text);e.fireEdit(t),e.replaceChild(u,t),e.insertBefore(a,u);var c=i.document.createRange();return c.setStart(u,s.startOffset),c.setEnd(u,s.endOffset),n.removeAllRanges(),n.addRange(c),!0}},function(e,t,n){var i=n(1),r=n(3),s=n(6),o=s.getSelection,a=s.correctSelection,u=/[\0-\x1F\x7F-\x9F\xAD\u0378\u0379\u037F-\u0383\u038B\u038D\u03A2\u0528-\u0530\u0557\u0558\u0560\u0588\u058B-\u058E\u0590\u05C8-\u05CF\u05EB-\u05EF\u05F5-\u0605\u061C\u061D\u06DD\u070E\u070F\u074B\u074C\u07B2-\u07BF\u07FB-\u07FF\u082E\u082F\u083F\u085C\u085D\u085F-\u089F\u08A1\u08AD-\u08E3\u08FF\u0978\u0980\u0984\u098D\u098E\u0991\u0992\u09A9\u09B1\u09B3-\u09B5\u09BA\u09BB\u09C5\u09C6\u09C9\u09CA\u09CF-\u09D6\u09D8-\u09DB\u09DE\u09E4\u09E5\u09FC-\u0A00\u0A04\u0A0B-\u0A0E\u0A11\u0A12\u0A29\u0A31\u0A34\u0A37\u0A3A\u0A3B\u0A3D\u0A43-\u0A46\u0A49\u0A4A\u0A4E-\u0A50\u0A52-\u0A58\u0A5D\u0A5F-\u0A65\u0A76-\u0A80\u0A84\u0A8E\u0A92\u0AA9\u0AB1\u0AB4\u0ABA\u0ABB\u0AC6\u0ACA\u0ACE\u0ACF\u0AD1-\u0ADF\u0AE4\u0AE5\u0AF2-\u0B00\u0B04\u0B0D\u0B0E\u0B11\u0B12\u0B29\u0B31\u0B34\u0B3A\u0B3B\u0B45\u0B46\u0B49\u0B4A\u0B4E-\u0B55\u0B58-\u0B5B\u0B5E\u0B64\u0B65\u0B78-\u0B81\u0B84\u0B8B-\u0B8D\u0B91\u0B96-\u0B98\u0B9B\u0B9D\u0BA0-\u0BA2\u0BA5-\u0BA7\u0BAB-\u0BAD\u0BBA-\u0BBD\u0BC3-\u0BC5\u0BC9\u0BCE\u0BCF\u0BD1-\u0BD6\u0BD8-\u0BE5\u0BFB-\u0C00\u0C04\u0C0D\u0C11\u0C29\u0C34\u0C3A-\u0C3C\u0C45\u0C49\u0C4E-\u0C54\u0C57\u0C5A-\u0C5F\u0C64\u0C65\u0C70-\u0C77\u0C80\u0C81\u0C84\u0C8D\u0C91\u0CA9\u0CB4\u0CBA\u0CBB\u0CC5\u0CC9\u0CCE-\u0CD4\u0CD7-\u0CDD\u0CDF\u0CE4\u0CE5\u0CF0\u0CF3-\u0D01\u0D04\u0D0D\u0D11\u0D3B\u0D3C\u0D45\u0D49\u0D4F-\u0D56\u0D58-\u0D5F\u0D64\u0D65\u0D76-\u0D78\u0D80\u0D81\u0D84\u0D97-\u0D99\u0DB2\u0DBC\u0DBE\u0DBF\u0DC7-\u0DC9\u0DCB-\u0DCE\u0DD5\u0DD7\u0DE0-\u0DF1\u0DF5-\u0E00\u0E3B-\u0E3E\u0E5C-\u0E80\u0E83\u0E85\u0E86\u0E89\u0E8B\u0E8C\u0E8E-\u0E93\u0E98\u0EA0\u0EA4\u0EA6\u0EA8\u0EA9\u0EAC\u0EBA\u0EBE\u0EBF\u0EC5\u0EC7\u0ECE\u0ECF\u0EDA\u0EDB\u0EE0-\u0EFF\u0F48\u0F6D-\u0F70\u0F98\u0FBD\u0FCD\u0FDB-\u0FFF\u10C6\u10C8-\u10CC\u10CE\u10CF\u1249\u124E\u124F\u1257\u1259\u125E\u125F\u1289\u128E\u128F\u12B1\u12B6\u12B7\u12BF\u12C1\u12C6\u12C7\u12D7\u1311\u1316\u1317\u135B\u135C\u137D-\u137F\u139A-\u139F\u13F5-\u13FF\u169D-\u169F\u16F1-\u16FF\u170D\u1715-\u171F\u1737-\u173F\u1754-\u175F\u176D\u1771\u1774-\u177F\u17DE\u17DF\u17EA-\u17EF\u17FA-\u17FF\u180F\u181A-\u181F\u1878-\u187F\u18AB-\u18AF\u18F6-\u18FF\u191D-\u191F\u192C-\u192F\u193C-\u193F\u1941-\u1943\u196E\u196F\u1975-\u197F\u19AC-\u19AF\u19CA-\u19CF\u19DB-\u19DD\u1A1C\u1A1D\u1A5F\u1A7D\u1A7E\u1A8A-\u1A8F\u1A9A-\u1A9F\u1AAE-\u1AFF\u1B4C-\u1B4F\u1B7D-\u1B7F\u1BF4-\u1BFB\u1C38-\u1C3A\u1C4A-\u1C4C\u1C80-\u1CBF\u1CC8-\u1CCF\u1CF7-\u1CFF\u1DE7-\u1DFB\u1F16\u1F17\u1F1E\u1F1F\u1F46\u1F47\u1F4E\u1F4F\u1F58\u1F5A\u1F5C\u1F5E\u1F7E\u1F7F\u1FB5\u1FC5\u1FD4\u1FD5\u1FDC\u1FF0\u1FF1\u1FF5\u1FFF\u200B-\u200F\u202A-\u202E\u2060-\u206F\u2072\u2073\u208F\u209D-\u209F\u20BB-\u20CF\u20F1-\u20FF\u218A-\u218F\u23F4-\u23FF\u2427-\u243F\u244B-\u245F\u2700\u2B4D-\u2B4F\u2B5A-\u2BFF\u2C2F\u2C5F\u2CF4-\u2CF8\u2D26\u2D28-\u2D2C\u2D2E\u2D2F\u2D68-\u2D6E\u2D71-\u2D7E\u2D97-\u2D9F\u2DA7\u2DAF\u2DB7\u2DBF\u2DC7\u2DCF\u2DD7\u2DDF\u2E3C-\u2E7F\u2E9A\u2EF4-\u2EFF\u2FD6-\u2FEF\u2FFC-\u2FFF\u3040\u3097\u3098\u3100-\u3104\u312E-\u3130\u318F\u31BB-\u31BF\u31E4-\u31EF\u321F\u32FF\u4DB6-\u4DBF\u9FCD-\u9FFF\uA48D-\uA48F\uA4C7-\uA4CF\uA62C-\uA63F\uA698-\uA69E\uA6F8-\uA6FF\uA78F\uA794-\uA79F\uA7AB-\uA7F7\uA82C-\uA82F\uA83A-\uA83F\uA878-\uA87F\uA8C5-\uA8CD\uA8DA-\uA8DF\uA8FC-\uA8FF\uA954-\uA95E\uA97D-\uA97F\uA9CE\uA9DA-\uA9DD\uA9E0-\uA9FF\uAA37-\uAA3F\uAA4E\uAA4F\uAA5A\uAA5B\uAA7C-\uAA7F\uAAC3-\uAADA\uAAF7-\uAB00\uAB07\uAB08\uAB0F\uAB10\uAB17-\uAB1F\uAB27\uAB2F-\uABBF\uABEE\uABEF\uABFA-\uABFF\uD7A4-\uD7AF\uD7C7-\uD7CA\uD7FC-\uF8FF\uFA6E\uFA6F\uFADA-\uFAFF\uFB07-\uFB12\uFB18-\uFB1C\uFB37\uFB3D\uFB3F\uFB42\uFB45\uFBC2-\uFBD2\uFD40-\uFD4F\uFD90\uFD91\uFDC8-\uFDEF\uFDFE\uFDFF\uFE1A-\uFE1F\uFE27-\uFE2F\uFE53\uFE67\uFE6C-\uFE6F\uFE75\uFEFD-\uFF00\uFFBF-\uFFC1\uFFC8\uFFC9\uFFD0\uFFD1\uFFD8\uFFD9\uFFDD-\uFFDF\uFFE7\uFFEF-\uFFFB\uFFFE\uFFFF]/g,c=/\u200B/,l="​";function d(e,t){if(t=t||o(e)){var n=t.focusNode&&t.focusNode.nodeType===Node.TEXT_NODE?t.focusNode:t.anchorNode&&t.anchorNode.nodeType===Node.TEXT_NODE?t.anchorNode:void 0;if(n){for(var i=n,r=n,s=n;s&&s.nodeType===Node.TEXT_NODE;)i=s,s=s.previousSibling;for(s=n;s&&s.nodeType===Node.TEXT_NODE;)r=s,s=s.nextSibling;var a=e.ownerDocument.createRange();return a.setStartBefore(i),a.setEndAfter(r),a}}}function f(e,t){if(!e||!e.rangeCount)return!1;var n=i.document.createElement("span");if(e.getRangeAt(0).surroundContents(n),n.parentNode.replaceChild(t,n),e.removeAllRanges(),t.nodeType===Node.TEXT_NODE){var r=i.document.createRange();r.setStart(t,t.nodeValue.length),r.collapse(!1),e.addRange(r)}else e.collapse(t,0);return!0}function h(e,t){for(var n=e,i=null,r="begin"===t?"previousSibling":"nextSibling";n&&n.nodeType===Node.TEXT_NODE;)i=n,n=n[r];return i}function m(e,t,n,s){var o=r.hasBubbles(s),a=i.document.createRange();a.setStart(t.node,t.offset),a.setEnd(n.node,n.offset);var u=_(a.toString());return!(!u&&(u||o))&&(u||a.collapse(),e.removeAllRanges(),e.addRange(a),!0)}function g(){return i.document.createTextNode(l)}function p(e){return c.test(e)}function _(e){return String(e||"").trim().replace(u,"")}t.isEmptyLeft=function(e){var t=a(e),n=t.startNode,i=t.startOffset,r=!0,s=n;for(;s&&s.nodeType===Node.TEXT_NODE;){var o=i>0?s.nodeValue.substring(0,i):s.nodeValue;if(_(o)){r=!1;break}i=0,s=s.previousSibling}return r},t.isEmptyRight=function(e){var t=a(e),n=t.endNode,i=t.endOffset,r=n;for(;r;){if(r.nodeType!==Node.TEXT_NODE)return!1;var s=i>-1&&i<r.nodeValue.length?r.nodeValue.substring(i):r.nodeValue;if(_(s))return!1;i=-1,r=r.nextSibling}return!0},t.arrowRight=function(e,t){if(!(e=e||i.getSelection())||!e.focusNode||e.focusNode.nodeType!==Node.TEXT_NODE)return!1;var n=a(e),r=n.startNode,s=n.endNode,o=n.startOffset,u=n.endOffset,c=n.revert;if(!e.isCollapsed&&!t)return e.collapse(s,u),!0;var l=c?r:s,d=c?o:u;for(;l;){if(l.nodeType!==Node.TEXT_NODE)return!1;var f=l.nodeValue.length;if(d+1>f)l=l.nextSibling,d=0;else{var h=l.nodeValue.substring(d,d+1);if(!p(h))break;d+=1}}if(!l)return!1;if(t){var m=Boolean(e.extend);if(m)e.extend(l,d+1);else{var g=i.document.createRange();c?(g.setStart(l,d+1),g.setEnd(s,u)):(g.setStart(r,o),g.setEnd(l,d+1)),e.removeAllRanges(),e.addRange(g)}}else e.collapse(l,d+1);return!0},t.arrowLeft=function(e,t){if(!(e=e||i.getSelection())||!e.anchorNode||e.anchorNode.nodeType!==Node.TEXT_NODE)return!1;var n=a(e),r=n.startNode,s=n.endNode,o=n.startOffset,u=n.endOffset,c=n.revert;if(!e.isCollapsed&&!t)return e.collapse(r,o),!0;var l=Boolean(e.extend),d=(c=l?c:!c)?r:s,f=c?o:u;for(;d;){if(d.nodeType!==Node.TEXT_NODE)return!1;if(null===f&&(f=d.nodeValue.length),f-1<0)d=d.previousSibling,f=null;else{var h=d.nodeValue.substring(f-1,f);if(!p(h))break;f-=1}}if(!d||null===f)return!1;if(t)if(l)e.extend(d,f-1);else{var m=i.document.createRange();c?(m.setStart(d,f-1),m.setEnd(s,u)):(m.setStart(r,o),m.setEnd(d,f-1)),e.removeAllRanges(),e.addRange(m)}else e.collapse(d,f-1);return!0},t.remove=function(e){return f(e,g())},t.html2text=function(e){if(!e)return"";var t=i.document.implementation.createHTMLDocument("").body;return t.innerText=e,t.innerText.replace(/^[\u0020\u00a0]+$/gm,"").replace(/\n/gm," ").trim()},t.currentTextRange=d,t.text2bubble=function(e,t){var n=o(e),i=n&&d(e,n);i?(n.removeAllRanges(),n.addRange(i),f(n,t)):e.appendChild(t);return!0},t.replaceString=function(e,t){if(!(e=_(e)))return!1;t=t||i.getSelection();var n=i.document.createTextNode(e);if(!f(t,n))return!1;return t.collapse(n,n.nodeValue.length),!0},t.findTextBorderNode=h,t.selectFromCursorToStrBegin=function(e,t){var n=(e=e||i.getSelection())&&e.anchorNode;if(!n||n.nodeType!==Node.TEXT_NODE)return!1;var r=e.anchorOffset,s=h(n,"begin");return m(e,{node:s,offset:0},{node:n,offset:r},t)},t.selectAll=function(e,t){var n=(e=e||i.getSelection())&&e.anchorNode;if(!n||n.nodeType!==Node.TEXT_NODE)return!1;var r=h(n,"begin"),s=h(n,"end");return m(e,{node:r,offset:0},{node:s,offset:s.nodeValue?s.nodeValue.length:0},t)},t.textClean=_,t.checkZws=p,t.createZws=g,t.hasNear=function(e){var t=(e=e||i.getSelection())&&e.anchorNode;if(!t||t.nodeType!==Node.TEXT_NODE)return!1;var n=h(t,"begin"),r=h(t,"end"),s=i.document.createRange();s.setStart(n,0),s.setEnd(r,r.nodeValue?r.nodeValue.length:0);var o=_(s.toString());return Boolean(o)}},function(e,t,n){var i=n(7),r=n(1),s=n(10).dispatch,o=n(12).EV,a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","`":"&#96;"},u={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'","&#96;":"`"},c=/&(?:amp|lt|gt|quot|#39|#96);/g,l=/[&<>"'`]/g,d=RegExp(c.source),f=RegExp(l.source),h=/Trident|Edge/,m=/IEMobile/;function g(e){return u[e]}function p(e){return a[e]}t.getSelection=function(e){var t=r.getSelection();if(t&&t.anchorNode&&e.compareDocumentPosition(t.anchorNode)&Node.DOCUMENT_POSITION_CONTAINED_BY)return t},t.correctSelection=function(e){var t=e.focusNode,n=e.focusOffset,i=e.anchorNode,r=e.anchorOffset,s=!1;i===t?(r=Math.min(e.anchorOffset,e.focusOffset),n=Math.max(e.anchorOffset,e.focusOffset),s=e.anchorOffset>e.focusOffset):e.anchorNode.compareDocumentPosition(e.focusNode)&Node.DOCUMENT_POSITION_PRECEDING&&(i=e.focusNode,r=e.focusOffset,t=e.anchorNode,n=e.anchorOffset,s=!0);return{startNode:i,endNode:t,startOffset:r,endOffset:n,revert:s}},t.throttle=function(e,t){var n=0,r=function(){n=0};return function(){n||(n=i(r),e.apply(t||this,arguments))}},t.escape=function(e){return(e=String(e))&&f.test(e)?e.replace(l,p):e},t.unescape=function(e){return(e=String(e))&&d.test(e)?e.replace(c,g):e},t.canUseDrag=!h.test(r.navigator.userAgent),t.isIE=h.test(r.navigator.userAgent),t.isMobileIE=m.test(r.navigator.userAgent),t.ready=function(){var e=[],t=!1,n=!1;function a(){i(function(){r.setTimeout(function(){e.length&&s(r,o.READY,{detail:{data:e.splice(0)}}),t=!0})})}return"complete"===r.document.readyState?a():"interactive"!==r.document.readyState||r.attachEvent||r.HTMLImports&&!r.HTMLImports.ready?r.addEventListener(r.HTMLImports&&!r.HTMLImports.ready?"HTMLImportsLoaded":"DOMContentLoaded",a):a(),function(a){e.push(a),t&&!n&&(n=!0,i(function(){s(r,o.READY,{detail:{data:e.splice(0)}}),n=!1}))}}()},function(e,t,n){(function(t){for(var i=n(8),r="undefined"==typeof window?t:window,s=["moz","webkit"],o="AnimationFrame",a=r["request"+o],u=r["cancel"+o]||r["cancelRequest"+o],c=0;!a&&c<s.length;c++)a=r[s[c]+"Request"+o],u=r[s[c]+"Cancel"+o]||r[s[c]+"CancelRequest"+o];if(!a||!u){var l=0,d=0,f=[];a=function(e){if(0===f.length){var t=i(),n=Math.max(0,1e3/60-(t-l));l=n+t,setTimeout(function(){var e=f.slice(0);f.length=0;for(var t=0;t<e.length;t++)if(!e[t].cancelled)try{e[t].callback(l)}catch(e){setTimeout(function(){throw e},0)}},Math.round(n))}return f.push({handle:++d,callback:e,cancelled:!1}),d},u=function(e){for(var t=0;t<f.length;t++)f[t].handle===e&&(f[t].cancelled=!0)}}e.exports=function(e){return a.call(r,e)},e.exports.cancel=function(){u.apply(r,arguments)},e.exports.polyfill=function(){r.requestAnimationFrame=a,r.cancelAnimationFrame=u}}).call(t,function(){return this}())},function(e,t,n){(function(t){(function(){var n,i,r;"undefined"!=typeof performance&&null!==performance&&performance.now?e.exports=function(){return performance.now()}:void 0!==t&&null!==t&&t.hrtime?(e.exports=function(){return(n()-r)/1e6},i=t.hrtime,r=(n=function(){var e;return 1e9*(e=i())[0]+e[1]})()):Date.now?(e.exports=function(){return Date.now()-r},r=Date.now()):(e.exports=function(){return(new Date).getTime()-r},r=(new Date).getTime())}).call(this)}).call(t,n(9))},function(e,t){var n,i,r=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===s||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:s}catch(e){n=s}try{i="function"==typeof clearTimeout?clearTimeout:o}catch(e){i=o}}();var u,c=[],l=!1,d=-1;function f(){l&&u&&(l=!1,u.length?c=u.concat(c):d=-1,c.length&&h())}function h(){if(!l){var e=a(f);l=!0;for(var t=c.length;t;){for(u=c,c=[];++d<t;)u&&u[d].run();d=-1,t=c.length}u=null,l=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===o||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function m(e,t){this.fun=e,this.array=t}function g(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];c.push(new m(e,t)),1!==c.length||l||a(h)},m.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=g,r.addListener=g,r.once=g,r.off=g,r.removeListener=g,r.removeAllListeners=g,r.emit=g,r.prependListener=g,r.prependOnceListener=g,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,n){var i=n(1),r=n(11),s=n(12).PROPS;function o(){var e=i.document.documentElement,t=i.document.body;return(e&&e.scrollLeft||t&&t.scrollLeft||0)-(e.clientLeft||0)}function a(){var e=i.document.documentElement,t=i.document.body;return(e&&e.scrollTop||t&&t.scrollTop||0)-(e.clientTop||0)}t.scrollX=o,t.scrollY=a,t.dispatch=function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};e.dispatchEvent(new u(t,n))},t.keyCode=function(e){return e.charCode||e.keyCode},t.metaKey=function(e){return e.ctrlKey||e.metaKey},t.pageX=function(e){return null===e.pageX&&null!==e.clientX?e.clientX+o():e.pageX},t.pageY=function(e){return null===e.pageY&&null!==e.clientY?e.clientY+a():e.pageY},t.one=function(e,t,n){d(e,t,n,!0,!1,!0)},t.on=function(e,t,n){d(e,t,n)},t.off=function(e,t,n){d(e,t,n,!1)},t.oneLocal=function(e,t,n){d(e,t,n,!0,!0,!0)},t.onLocal=function(e,t,n){d(e,t,n,!0,!0)},t.offLocal=function(e,t,n){d(e,t,n,!1,!0)},t.prevent=function(e){return e.cancelBubble=!0,e.returnValue=!1,e.stopImmediatePropagation(),e.stopPropagation(),e.preventDefault(),!1},t.proxyLocal=function(e){!function(e,t){for(var n=e[s.LOCAL_EVENTS]&&e[s.LOCAL_EVENTS][t.type]||[],i={},r=0;r<n.length&&!t.immediatePropagationStopped;r++)n[r](t,i)}(e.currentTarget,e)};var u="function"==typeof i.CustomEvent?i.CustomEvent:r;function c(e,t,n){return function i(r){e.removeEventListener(t,i),n(r)}}var l={addLocalEventListener:function(e,t,n){(function(e,t){return e[s.LOCAL_EVENTS]||(e[s.LOCAL_EVENTS]={}),e[s.LOCAL_EVENTS][t]||(e[s.LOCAL_EVENTS][t]=[]),e[s.LOCAL_EVENTS][t]})(e,t).push(n)},removeLocalEventListener:function(e,t,n){for(var i=e[s.LOCAL_EVENTS]&&e[s.LOCAL_EVENTS][t]||[],r=0;r<i.length;)i[r]===n?i.splice(r,1):r++},addEventListener:function(e,t,n){e.addEventListener(t,n)},removeEventListener:function(e,t,n){e.removeEventListener(t,n)}};function d(e,t,n){var i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5],o=n?function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}({},t,n):t,a="".concat(i?"add":"remove").concat(r?"Local":"","EventListener");for(var u in o){var d=s?c(e,u,o[u]):o[u];l[a](e,u,d)}}},function(e,t,n){var i=n(1),r=i.document,s=i.Event.prototype,o=!1;try{o=Boolean(r.createEvent("CustomEvent"))}catch(e){}var a=s.stopImmediatePropagation;s.stopImmediatePropagation=function(){this.immediatePropagationStopped=!0,a?a.call(this):this.stopPropagation()};var u=o?function(e,t){t=t||{};var n=Boolean(t.bubbles),i=Boolean(t.cancelable),s=r.createEvent("CustomEvent");return s.initCustomEvent(e,n,i,t.detail),s}:function(e,t){t=t||{};var n=Boolean(t.bubbles),i=Boolean(t.cancelable),s=r.createEvent("Event");return s.initEvent(e,n,i),s.detail=t.detail,s};u.prototype=s,e.exports=u},function(e,t){t.KEY={a:65,Backspace:8,Bottom:40,c:67,Cmd:91,Comma:44,Delete:46,Enter:13,Esc:27,Home:36,Left:37,Right:39,Semicolon:59,Space:32,Tab:9,Top:38,x:88},t.CLS={DRAGSTART:"drag",DROPZONE:"dropzone"},t.EV={BEFORE_REMOVE:"before-remove",BUBBLE_EDIT:"bubble-edit",BUBBLE_INPUT:"bubble-input",CHANGE:"change",DRAGEND:"dragend",DRAGENTER:"dragenter",DRAGLEAVE:"dragleave",DRAGSTART:"dragstart",DROP:"drop",READY:"x-bubbles-ready"},t.PROPS={BUBBLE_VALUE:"__bubble_value__",CLICK_TIME:"__click_time__",LOCAL_EVENTS:"__events__",LOCK_COPY:"__lock_copy__",OPTIONS:"__options__"}},function(e,t,n){var i=n(1),r=n(5),s=n(14),o=n(6),a=n(15);function u(e){var t=r.createZws();if(e.hasChildNodes()){var n=e.childNodes[e.childNodes.length-1];n.isEqualNode(t)?t=n:e.appendChild(t)}else e.appendChild(t);return t}t.restore=function(e){if(!o.isMobileIE){if(a.init(e),!e.canAddBubble())return void s.setLast(e);s.clear(e);var t=u(e),n=i.getSelection();n.removeAllRanges(),n.collapse(t,1)}},t.restoreBasis=u},function(e,t,n){var i=n(1),r=n(6),s=n(4),o=n(3),a=Array.prototype.slice,u="[bubble][selected]",c="[bubble]:not([selected])";function l(e){var t=d(e);return t[t.length-1]}function d(e){return a.call(e.querySelectorAll(u))}function f(e){d(e).forEach(function(e){return e.removeAttribute("selected")})}function h(e){if(g(e)){var t=o.closestNodeSet(e);return t.startRangeSelect=e,s.bubbling(t),!0}return!1}function m(e){if(!s.isBubbleNode(e))return!1;var t=o.closestNodeSet(e),n=i.getSelection();return n&&n.removeAllRanges(),f(t),h(e)}function g(e){return!!s.isBubbleNode(e)&&(e.setAttribute("selected",""),!0)}t.all=function(e){a.call(e.querySelectorAll(c)).forEach(function(e){return g(e)}),e.startRangeSelect=e.querySelector(u),s.bubbling(e);var t=i.getSelection();t&&t.removeAllRanges()},t.allLeft=function(e){var t=l(e);if(!t)return;for(var n=o.prevBubble(t);n;n=o.prevBubble(n))g(n);e.startRangeSelect=e.querySelector(u),s.bubbling(e);var r=i.getSelection();r&&r.removeAllRanges()},t.add=h,t.clear=f,t.get=d,t.uniq=m,t.head=function(e){return d(e)[0]},t.last=l,t.has=function(e){return Boolean(e.querySelector(u))},t.range=function(e){if(!s.isBubbleNode(e))return;var t=e.parentNode,n=d(t);if(!n.length)return void m(e);f(t);var i,r,o=n[0],a=n[n.length-1];o!==a&&t.startRangeSelect||(t.startRangeSelect=o);e.compareDocumentPosition(t.startRangeSelect)&Node.DOCUMENT_POSITION_PRECEDING?(i=t.startRangeSelect,r=e):(i=e,r=t.startRangeSelect);if(i&&r){for(var u=i;u&&g(u)&&u!==r;)u=u.nextSibling;s.bubbling(t)}},t.toggleUniq=function(e){if(function(e){return s.isBubbleNode(e)&&e.hasAttribute("selected")||!1}(e)){var t=o.closestNodeSet(e);if(1===d(t).length)return function(e){if(s.isBubbleNode(e))return e.removeAttribute("selected"),!0;return!1}(e)}return m(e)},t.setLast=function(e){return m(o.lastBubble(e))},t.getEditable=function(e){if(!e.options("selection"))return!1;var t=r.getSelection(e);if(t&&t.rangeCount)return!1;var n=d(e);if(1!==n.length)return!1;return n[0]}},function(e,t,n){function i(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var r=n(3),s=n(14),o=n(13),a=n(10);t.init=function(e){a.on(e,"mousedown",c),a.on(document,"handledragend",d)},t.destroy=function(e){a.off(e,"mousedown",c)},t.clean=function(){a.off(document,"mousemove",l)};var u={_onMouseMove:function(){},_onMouseUp:function(){}};function c(e){var t=r.closestNodeSet(e.target),n=e.target.parentNode.parentNode;t&&(n&&!n.hasAttribute("selected")&&(o.restore(t),a.dispatch(document,"deselectafterclick",{detail:{wasSelectedPreviously:!1}})),n&&n.hasAttribute("selected")||(t.focus(),u._onMouseMove=function(e){return l(e,t)},u._onMouseUp=function(e){return d(e,t)},a.on(document,"mousemove",u._onMouseMove),a.on(document,"mouseup",u._onMouseUp)))}function l(e,t){var n=r.closestNodeBubble(e.target);n&&t.contains(n)&&s.range(n)}function d(e,t){u._onMouseMove&&u._onMouseUp&&(a.off(document,"mousemove",u._onMouseMove),a.off(document,"mouseup",u._onMouseUp),t&&Boolean(i(t.children).map(function(e){return e.hasAttribute("selected")}).filter(Boolean).length)&&(a.dispatch(document,"deselectafterclick",{detail:{wasSelectedPreviously:!0}}),e.stopPropagation()))}},function(e,t,n){var i=n(17),r=n(20),s=n(6).canUseDrag;t.init=function(e){return s?i.init(e):r.init(e)},t.destroy=function(e){return s?i.destroy(e):r.destroy(e)}},function(e,t,n){var i=n(1),r=n(14),s=n(3),o=n(10),a=n(12).CLS,u=n(15).clean,c=n(18),l=c.getDragImage,d=c.onDropSuccess,f=c.DRAG_IMG,h={dragend:function(e){if(e.stopPropagation(),e.preventDefault(),!m)return;m.classList.remove(a.DRAGSTART);var t=s.closestNodeSet(e.target);t&&t!==m&&t.classList.remove(a.DROPZONE);m=null},dragenter:function(e){if(e.stopPropagation(),e.preventDefault(),!m)return;var t=s.closestNodeSet(e.target);t&&t!==m&&t.classList.add(a.DROPZONE)},dragleave:function(e){if(e.stopPropagation(),e.preventDefault(),o.dispatch(document,"handledragend",{}),!m)return;var t=s.closestNodeSet(e.target);t&&t!==m&&t.classList.remove(a.DROPZONE)},dragover:function(e){if(e.stopPropagation(),e.preventDefault(),!m)return;e.dataTransfer.dropEffect="move"},dragstart:function(e){e.stopPropagation(),u();var t=s.closestNodeSet(e.target),n=s.closestNodeBubble(e.target);if(!t||!n)return void e.preventDefault();var o=i.getSelection();o&&o.removeAllRanges(),m=t,t.classList.add(a.DRAGSTART),r.add(n),e.dataTransfer.effectAllowed="move",e.dataTransfer.setData("text/plain",""),r.get(m).length>1&&e.dataTransfer.setDragImage(l(),f.w,f.h)},drop:function(e){if(e.stopPropagation(),e.preventDefault(),o.dispatch(document,"handledragend",{}),!m)return;var t=s.closestNodeSet(e.target);if(!t||t===m)return;var n=t.options("checkBubbleDrop"),a=r.get(m);a.length&&n(a)&&(s.moveBubbles(m,t,a),i.setTimeout(d,0,m,t))}},m=null;t.init=function(e){o.on(e,h)},t.destroy=function(e){o.off(e,h)}},function(e,t,n){var i=null;t.DRAG_IMG={w:16,h:16},t.getDragImage=function(){return i||((i=new Image).src=n(19)),i},t.onDropSuccess=function(e,t){e.fireChange(),t.focus(),t.fireChange()}},function(e,t){e.exports="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAE8AAAAVCAMAAAAw/0MlAAABblBMVEUAAABOXIZJWIKCkbeNnMKMmsJNW4VNW4VWZY57ibFHV4KVpMxRYImCkLh9jbpgcJ1fcJ1JWoaZqdNUZpaHmMaVpdJIWolTZJKHmMZEV4iXqNdkdqhjdal2iLx2ib2Knc6PodNJXpJJXpNOYpdpfLKCk8JPYpdofLNugblugrqUptdZdLdZd8Nfeb93js1+ksuGm9SGm9VHaLhJarxKZqxKbL9La7pNbr9Pb71Ucr1Wbag/XqU/X6pAVopffMdjf8ZphMpwicx2js9BW51CWZN/ldCBl9KCmNNFYKRFZbGJndWOodVKX5RKX5ZKYJdWdcNXbKJYdL1KYJtAVYpaeMVJXpJKbMBgebpjeLBjf8VLYp5kd65kgMlofLRog8log8tJYqBth8xugrpviMtNabBxi851jc8/X6t3i8BOaK56kdB9lNFOaa5Ob8FPY5qBl9NGXJODmNOEmdNQbrpRcsJUb7RGXJSTptmUptiUp9kfFguNAAAAK3RSTlMAJCQkJDw8P0JCRUVubpaWlpmZwMDAw8nJzMzV29vb7e3t7fDw+Pn5+fn8jndhZAAAAQhJREFUeF6tz2VXwgAYBtBnhBKKkgoGKPY2urvT7u7ujn/vtsM5fN/e+w8uJEaLa+HvR7Zfl8WILo293Qq8vykQaLXtGnRoPcH6i1L1oEcLidpde6BQc6shslXvaVSHIdD7S9c0Sv5+ACbfFRXftBoYuzijUry1AXPHJ1QK5349pvYOqeSPfCaM8Dkq/EFxHAMst0mDY3cL89Clkis0kqmd/CxgvUt8Ukg8rub4UYCZicTiT0rFY5HnNY4dBNC32GiGwtFt+aLhULOx9CWMdRAMbVXK6cyNfJl0ubL8IYytEDHe0/XX7IZ82e/9S3HsZSDpmSQZT/SiQ+UgGDtU6DKYnYrGTrMBon97+TS1J80efgAAAABJRU5ErkJggg=="},function(e,t,n){var i=n(1),r=n(10),s=n(6),o=n(14),a=n(3),u=n(21),c=n(12),l=c.CLS,d=c.EV,f=n(18),h=f.getDragImage,m=f.onDropSuccess,g=f.DRAG_IMG,p=null,_=null,v=null;function b(e){var t=a.closestNodeBubble(e.target);if(t){var n=a.closestNodeSet(e.target);if(n){e.preventDefault(),n.focus();var u=n.__drag__={nodeBubble:t,nodeOffsetX:e.offsetX,nodeOffsetY:e.offsetY,onMousemove:s.throttle(E.bind(this,n)),onMouseup:function(e,t){var n=e.__drag__;if(!n)return;r.off(document,"mousemove",n.onMousemove),r.off(document,"scroll",n.onScroll),delete e.__drag__,v&&(v.parentNode&&v.parentNode.removeChild(v),v=null);if(_){var s=_;_=null,s.classList.remove(l.DROPZONE),r.dispatch(s,d.DRAGLEAVE,{bubbles:!1,cancelable:!1})}if(p){var u=a.closestNodeSet(t.target);if(u&&u!==p){var c=o.get(p),f=u.options("checkBubbleDrop");c.length&&f(c)&&(a.moveBubbles(p,u,c),i.setTimeout(m,0,p,u))}var h=p;p=null,h.classList.remove(l.DRAGSTART),r.dispatch(h,d.DROP,{bubbles:!1,cancelable:!1}),r.dispatch(h,d.DRAGEND,{bubbles:!1,cancelable:!1,detail:{target:o.head(h)}})}}.bind(this,n),onScroll:s.throttle(y.bind(this,n)),x:0,y:0};p=null,_=null,v=null,r.one(document,"mouseup",u.onMouseup),r.on(document,"mousemove",u.onMousemove),r.on(document,"scroll",u.onScroll)}}}function E(e){var t=e.__drag__;if(t){if(!p){var n,s=i.getSelection();s&&s.removeAllRanges(),(p=e).classList.add(l.DRAGSTART),o.add(t.nodeBubble),1===o.get(p).length&&(n=t.nodeBubble.cloneNode(!0)),n||(n=h(),t.nodeOffsetX=g.w,t.nodeOffsetY=g.h),(v=document.body.appendChild(document.createElement("div"))).style.cssText="position:absolute;z-index:9999;pointer-events:none;top:0;left:0;",v.appendChild(n),r.dispatch(p,d.DRAGSTART,{bubbles:!1,cancelable:!1,detail:{target:o.head(p)}})}t.x=event.clientX,t.y=event.clientY,y(e);var u=a.closestNodeSet(event.target);if(u&&u!==p)_&&_!==u?(_.classList.remove(l.DROPZONE),u.classList.add(l.DROPZONE),_=u,r.dispatch(_,d.DRAGENTER,{bubbles:!1,cancelable:!1})):_||(u.classList.add(l.DROPZONE),_=u,r.dispatch(_,d.DRAGENTER,{bubbles:!1,cancelable:!1}));else if(_){var c=_;_=null,c.classList.remove(l.DROPZONE),r.dispatch(c,d.DRAGLEAVE,{bubbles:!1,cancelable:!1})}}}function y(e){var t=e.__drag__;if(t&&v){var n=t.x-t.nodeOffsetX+r.scrollX(),i=t.y-t.nodeOffsetY+r.scrollY();u.csstransforms3d?v.style.transform="translate3d(".concat(n,"px, ").concat(i,"px, 0px)"):u.csstransforms?v.style.transform="translate(".concat(n,"px, ").concat(i,"px)"):(v.style.top="".concat(i,"px"),v.style.left="".concat(n,"px"))}}t.init=function(e){r.on(e,"mousedown",b)},t.destroy=function(e){r.off(e,"mousedown",b)}},function(e,t){e.exports=window.Modernizr},function(e,t,n){var i=n(10),r=n(12).PROPS;e.exports=function(e){if(e.currentTarget[r.LOCK_COPY])return i.prevent(e)}},function(e,t,n){var i=n(10),r=n(3),s=n(12).PROPS;e.exports=function(e,t){var n=r.closestNodeSet(e.target);if(!n)return i.prevent(e);if(t.nodeEditor=n,t.nodeBubble=r.closestNodeBubble(e.target),t.isDblclick=!1,t.canAddBubble=n.canAddBubble(),t.nodeBubble){var o=Date.now();t.isDblclick=n[s.CLICK_TIME]&&o-n[s.CLICK_TIME]<200,n[s.CLICK_TIME]=o}}},function(e,t,n){var i=n(7),r=n(1),s=n(10),o=n(12).PROPS;e.exports=function(e){var t=e.currentTarget;if(t[o.LOCK_COPY])return s.prevent(e),delete t[o.LOCK_COPY],i(function(){var e=r.getSelection();e&&e.removeAllRanges()}),!1}},function(e,t,n){var i=n(6),r=n(10),s=n(12).KEY;e.exports=function(e,t){var n=r.keyCode(e);switch(t.nodeEditor=e.currentTarget,n){case s.Left:case s.Right:case s.Delete:case s.Backspace:e.preventDefault(),t.selection=i.getSelection(e.currentTarget)}}},function(e,t,n){var i=n(4);e.exports=function(e){i.bubbling(e.currentTarget)}},function(e,t,n){function i(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var r=n(10),s=n(4),o=n(13),a=n(6),u=!1;r.on(document,"deselectafterclick",function(e){var t=e.detail,n=t.wasSelectedPreviously,i=t.sharedData;n!==u&&(i&&u&&o.restore(i.nodeEditor),setTimeout(function(){return u=Boolean(n)},50))}),e.exports=function(e,t){var n=t.nodeEditor,c=t.nodeBubble,l=t.isDblclick;if(c)l?e.shiftKey||r.metaKey(e)||s.edit(n,c):n.options("selection")||(s.bubbling(n),o.restore(n));else{var d=a.getSelection(n),f=Boolean(i(n.children).map(function(e){return e.hasAttribute("selected")}).filter(Boolean).length);d&&d.anchorNode.nodeType===Node.TEXT_NODE||f||u||o.restore(n),f&&(e.stopPropagation(),e.stopImmediatePropagation(),e.preventDefault()),u&&r.dispatch(document,"deselectafterclick",{detail:{wasSelectedPreviously:!1,sharedData:t}})}}},function(e,t,n){var i=n(3);e.exports=function(e){var t=i.closestNodeSet(e.target);t&&(i.closestNodeBubble(e.target)||t.canAddBubble()||(t.focus(),e.preventDefault()))}},function(e,t,n){function i(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var r=n(7),s=n(10),o=n(13),a=n(1);e.exports=function(e){var t=e.currentTarget;if(t.canAddBubble()||r(function(){var e=a.getSelection();e&&e.removeAllRanges()}),Boolean(i(t.children).map(function(e){return e.hasAttribute("selected")}).filter(Boolean).length))return s.dispatch(document,"deselectafterclick",{detail:{wasSelectedPreviously:!1}});o.restore(t)}},function(e,t,n){var i=n(10),r=n(4),s=n(13),o=n(5),a=n(3),u=n(12).KEY;e.exports=function(e,t){var n=i.keyCode(e),c=i.metaKey(e);switch(n){case u.Esc:e.preventDefault(),r.bubbling(t.nodeEditor),s.restore(t.nodeEditor);break;case u.Backspace:!function(e,t){var n=t.selection;if(!n)return;var i=t.nodeEditor;if(!n.isCollapsed||o.arrowLeft(n,!0))o.remove(n),i.fireInput(),o.hasNear(n)||i.fireChange();else if(i.options("selection"))t.isEmptyLeft=!0;else{var r=a.findBubbleLeft(n);r&&(a.removeBubbles(i,[r]),i.fireChange())}}(0,t);break;case u.Delete:!function(e,t){var n=t.selection;if(!n)return;var i=t.nodeEditor;if(!n.isCollapsed||o.arrowRight(n,!0))o.remove(n),i.fireInput(),o.hasNear(n)||i.fireChange();else if(i.options("selection"))t.isEmptyRight=!0;else{var r=a.findBubbleRight(n);r&&(a.removeBubbles(i,[r]),i.fireChange())}}(0,t);break;case u.Left:!function(e,t){t.isEmptyLeft=!o.arrowLeft(t.selection,e.shiftKey)}(e,t);break;case u.Right:!function(e,t){t.isEmptyRight=!o.arrowRight(t.selection,e.shiftKey)}(e,t);break;case u.Home:e.shiftKey&&(e.preventDefault(),t.isTextSelectedFromBeginToCursor=o.selectFromCursorToStrBegin(null,t.nodeEditor));break;case u.a:c&&(e.preventDefault(),t.isTextSelectAll=o.selectAll(null,t.nodeEditor))}}},function(e,t,n){var i=n(10),r=n(4),s=n(13),o=n(14),a=n(12).KEY;e.exports=function(e,t){var n=i.keyCode(e),u=e.currentTarget;if(t.enterBubbling=!1,n===a.Enter)e.preventDefault(),u.options("disableControls")||o.getEditable(u)||(r.bubbling(u),s.restore(u),t.enterBubbling=!0);else if(u.canAddBubble()){var c=u.options("separator");if(c&&c.test(String.fromCharCode(n))){var l=u.options("separatorCond");l&&!l(u.inputValue)||(e.preventDefault(),r.bubbling(u),s.restore(u))}}else e.preventDefault()}},function(e,t,n){var i=n(10),r=n(12).KEY;e.exports=function(e){var t=e.currentTarget,n=i.keyCode(e);(e.key?1===e.key.length:(n>47||n===r.Space||n===r.Backspace)&&n!==r.Cmd)&&t.canAddBubble()&&t.fireInput()}},function(e,t,n){var i=n(7),r=n(1),s=n(4),o=n(13),a=n(5),u=n(6).isIE;function c(e,t){var n=e.options("checkBubblePaste"),s=e.options("lineBreakReplacer"),o=r.getSelection();t&&s&&(t=t.replace(/\n/g,s));var c=!(!t||!o.isCollapsed||e.inputValue)&&n(t);return!!a.replaceString(t,o)&&(c?u?i(function(){return l(e)}):l(e):e.fireInput(),!0)}function l(e){s.bubbling(e),e.focus(),i(function(){return o.restore(e)})}e.exports=function(e){e.preventDefault();var t=e.currentTarget;if(t.canAddBubble())if(r.clipboardData&&r.clipboardData.getData)c(t,r.clipboardData.getData("Text"));else if(e.clipboardData){var n=e.clipboardData,i=n.getData&&n.getData("text/plain");!c(t,i)&&n.items&&Array.prototype.slice.call(n.items).filter(function(e){return"string"===e.kind&&"text/plain"===e.type}).some(function(e){return e.getAsString(function(e){c(t,e)}),!0})}}},function(e,t,n){var i=n(14);e.exports=function(e){i.clear(e.currentTarget)}},function(e,t,n){function i(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var r=n(10),s=n(14);e.exports=function(e,t){var n=t.nodeEditor,o=t.nodeBubble,a=t.isDblclick,u=t.canAddBubble,c=Boolean(i(n.children).map(function(e){return e.hasAttribute("selected")}).filter(Boolean).length);if(o)return r.metaKey(e)?void s.add(o):e.shiftKey?void(n.startRangeSelect?s.range(o):s.uniq(o)):a?void 0:void(u?s.toggleUniq(o):s.uniq(o));u&&!c&&s.clear(n)}},function(e,t,n){var i=n(7),r=n(10),s=n(6),o=n(4),a=n(14),u=n(3),c=n(13),l=n(12),d=l.KEY,f=l.PROPS;function h(e,t){var n=t.nodeEditor,r=t.selection;if(r){if(t.isEmptyRight){var s=u.findBubbleRight(r);s&&a.uniq(s)}}else m(n,!0)||(n.focus(),i(function(){return c.restore(n)}))}function m(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=a.get(e);if(!n.length)return!1;var r=n[0].previousSibling,s=n[n.length-1].nextSibling;if(t){var l=r;r=s,s=l}return u.removeBubbles(e,n),o.isBubbleNode(r)?a.uniq(r):o.isBubbleNode(s)?a.uniq(s):(e.focus(),i(function(){return c.restore(e)})),e.fireChange(),!0}function g(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:function(){};if(s.getSelection(e))return!1;var n=a.get(e);if(!n.length)return!1;var o=e.options("bubbleCopy")(n);if(!o)return!1;e[f.LOCK_COPY]=!0;var u=e.ownerDocument.createElement("input");return u.value=o,u.style.cssText="\n        position: absolute;\n        left: -9999px;\n        width: 1px;\n        height: 1px;\n        margin: 0;\n        padding: 0;\n        border: none;",e.parentNode.appendChild(u),r.one(u,{keyup:function(){return e.focus()},blur:function(){u&&u.parentNode&&u.parentNode.removeChild(u),i(t)}}),u.select(),!0}e.exports=function(e,t){var n=r.keyCode(e),s=r.metaKey(e);switch(n){case d.Backspace:!function(e,t){var n=t.nodeEditor,r=t.selection;if(r){if(t.isEmptyLeft){var s=u.findBubbleLeft(r);s&&a.uniq(s)}}else m(n)||(n.focus(),i(function(){return c.restore(n)}))}(0,t);break;case d.Delete:h(e,t);break;case d.Left:!function(e,t){var n=t.selection;if(n){if(t.isEmptyLeft){var i=u.findBubbleLeft(n);i&&a.uniq(i)}}else{var r=t.nodeEditor,s=a.get(r),o=s.length>1&&s[0]===r.startRangeSelect?s[s.length-1]:s[0],c=u.prevBubble(o);c&&(e.shiftKey?a.range(c):a.uniq(c))}}(e,t);break;case d.Right:!function(e,t){var n=t.selection;if(n){if(t.isEmptyRight){var i=u.findBubbleRight(n);i&&a.uniq(i)}}else{var r=t.nodeEditor,s=a.get(r),o=s.length>1&&s[s.length-1]===r.startRangeSelect?s[0]:s[s.length-1],l=u.nextBubble(o);l?e.shiftKey?a.range(l):a.uniq(l):c.restore(r)}}(e,t);break;case d.Top:e.preventDefault(),function(e,t){var n=t.nodeEditor;if(n.options("disableControls"))return;var i=u.headBubble(n);i&&a.uniq(i)}(0,t);break;case d.Bottom:e.preventDefault(),function(e,t){var n=t.nodeEditor;if(n.options("disableControls"))return;a.has(n)&&c.restore(n)}(0,t);break;case d.Home:e.shiftKey&&!t.isTextSelectedFromBeginToCursor&&a.has(t.nodeEditor)&&(e.preventDefault(),a.allLeft(t.nodeEditor));break;case d.a:s&&!t.isTextSelectAll&&(e.preventDefault(),a.all(t.nodeEditor));break;case d.c:s&&g(t.nodeEditor);break;case d.x:s&&g(t.nodeEditor,function(){return h(e,t)})}}},function(e,t,n){var i=n(10),r=n(4),s=n(14),o=n(12).KEY;function a(e){var t=s.getEditable(e);return!!t&&r.edit(e,t)}e.exports=function(e,t){var n=i.keyCode(e),r=e.currentTarget;n===o.Enter?(e.preventDefault(),r.options("disableControls")||t.enterBubbling||a(r)):n===o.Space&&a(r)&&e.preventDefault()}},function(e,t,n){function i(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],i=!0,r=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(i=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);i=!0);}catch(e){r=!0,s=e}finally{try{i||null==a.return||a.return()}finally{if(r)throw s}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var s=n(1),o=n(12).PROPS,a=/\/(.+)\/([gimy]{0,3})/i,u={begining:["reg",null,"begining"],bubbleCopy:["func",function(e){return e.map(function(e){return e.innerHTML}).join(", ")},"bubble-copy"],bubbleDeformation:["func",function(){},"bubble-deformation"],bubbleFormation:["func",function(){},"bubble-formation"],checkBubblePaste:["func",function(){return!0},"check-bubble-paste"],checkBubbleDrop:["func",function(){return!0},"check-bubble-drop"],classBubble:["str","bubble","class-bubble"],disableControls:["bool",!1,"disable-controls"],draggable:["bool",!0,"draggable"],ending:["reg",null,"ending"],limit:["uint",0,"limit"],selection:["bool",!0,"selection"],separator:["reg",/[,;]/,"separator"],separatorCond:["func",null,"separator-cond"],tokenizer:["func",null,"tokenizer"]},c={func:function(e){switch(r(e)){case"string":return new Function("context","return context.".concat(e,";"))(s);case"function":return e}},bool:function(e){switch(r(e)){case"string":return"true"===e||"on"===e;case"boolean":return e}},noop:function(e){return e},reg:function(e){switch(r(e)){case"string":if(e){var t=e.match(a);if(t)return new RegExp(t[1],t[2])}return null;case"object":if(e instanceof s.RegExp||null===e)return e}},str:function(e){if(void 0!==e)return e?String(e):""},uint:function(e){if(e=Number(e),!isNaN(e)&&e>0)return e}};function l(e){var t=arguments.length<=1?void 0:arguments[1];if(t){if(e[o.OPTIONS]||d(e),"object"===r(t)&&null!==t){var n=t;return Object.keys(n).forEach(function(t){e[o.OPTIONS][t]=n[t]}),void f(e[o.OPTIONS])}var i=t,s=arguments.length<=2?void 0:arguments[2];if(void 0===s)return e[o.OPTIONS][i];e[o.OPTIONS][i]=s,f(e[o.OPTIONS])}else d(e)}function d(e){var t=e[o.OPTIONS]=e[o.OPTIONS]||{};for(var n in u){var i="data-".concat(u[n][2]);e.hasAttribute(i)&&(t[n]=e.getAttribute(i))}f(t)}function f(e){for(var t in u){var n=i(u[t],2),r=n[0],s=n[1];e[t]=c[r](e[t]),void 0===e[t]&&(e[t]=s)}}l.attributes=Object.keys(u).map(function(e){return"data-".concat(u[e][2])}),e.exports=l}])},338:function(e,t,n){"use strict";var i=this&&this.__createBinding||(Object.create?function(e,t,n,i){void 0===i&&(i=n),Object.defineProperty(e,i,{enumerable:!0,get:function(){return t[n]}})}:function(e,t,n,i){void 0===i&&(i=n),e[i]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.BanReason=t.WorkModes=t.TimePresets=t.SuggestTypes=t.SmartSubjectType=t.Settings=t.SendError=t.ResolutionTypes=t.PromoTypes=t.Popups=t.Limits=t.LeaveTypes=t.InputTypes=t.FixedModes=void 0;var o=s(n(482));t.FixedModes=o;var a=s(n(483));t.InputTypes=a;var u=s(n(460));t.LeaveTypes=u;var c=s(n(461));t.Limits=c;var l=s(n(424));t.Popups=l;var d=s(n(484));t.PromoTypes=d;var f=s(n(485));t.ResolutionTypes=f;var h=s(n(462));t.SendError=h;var m=s(n(486));t.Settings=m;var g=s(n(487));t.SmartSubjectType=g;var p=s(n(488));t.SuggestTypes=p;var _=s(n(441));t.TimePresets=_;var v=s(n(489));t.WorkModes=v;var b=n(490);Object.defineProperty(t,"BanReason",{enumerable:!0,get:function(){return b.BanReason}})},349:function(e,t,n){"use strict";var i=n(716),r=n(659),s=n(717),o=n(995);n(996);n.d(t,"b",function(){return i}),n.d(t,"c",function(){return s}),n.d(t,"a",function(){return o}),n.d(t,"d",function(){return r})},424:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TOO_MANY_SUBSCRIBERS=t.VALIDATION_ERROR=t.SEND_RETRYABLE_FAILED=t.SEND_FAILED=t.REMOVE_DRAFT=t.LIMITED_RECIPIENTS=t.EMPTY_SUBJECT=t.DISK_RESOURCES=t.CONTACTS_SUGGEST=t.CONFIRM_REMOVE=t.CHECKBOX_CAPTCHA=t.CAPTCHA=t.ATTACHMENTS_ERROR=void 0,t.ATTACHMENTS_ERROR="AttachmentsError",t.CAPTCHA="Captcha",t.CHECKBOX_CAPTCHA="CheckboxCaptcha",t.CONFIRM_REMOVE="ConfirmRemove",t.CONTACTS_SUGGEST="ContactsSuggest",t.DISK_RESOURCES="DiskResources",t.EMPTY_SUBJECT="EmptySubject",t.LIMITED_RECIPIENTS="LimitedRecipients",t.REMOVE_DRAFT="RemoveDraft",t.SEND_FAILED="SendFailed",t.SEND_RETRYABLE_FAILED="SendRetryableFailed",t.VALIDATION_ERROR="ValidationError",t.TOO_MANY_SUBSCRIBERS="TooManySubscribers"},441:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NEXT_WEEK=t.WEEKEND=t.TOMORROW=t.TODAY=void 0,t.TODAY="today",t.TOMORROW="tomorrow",t.WEEKEND="weekend",t.NEXT_WEEK="next week"},460:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SENT=t.DELETE=t.CLOSE=t.COLLAPSE=void 0,t.COLLAPSE="collapse",t.CLOSE="close",t.DELETE="delete",t.SENT="sent"},461:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.MAX_SUGGEST_ITEMS_FOR_POPUP=void 0,t.MAX_SUGGEST_ITEMS_FOR_POPUP=3},462:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.RETRYABLE_ERRORS=t.UNDO_ERRORS=t.MAILING_LIST_NOT_ALLOWED=t.TOO_MANY_SUBSCRIBERS=t.VIRUS=t.UNDO_PAUSED=t.UNDO_MESSAGE_SAVED=t.UNDO_CANNOT_SAVE=t.TOO_MANY_EMAILS=t.TOO_BIG_ATTACHMENTS=t.TOO_BIG=t.SPAM=t.NO_RECIPIENTS=t.NO_NETWORK=t.NO_DATA=t.MAX_EMAIL_ADDRESS_REACHED=t.LIMIT_FAIL=t.INTERNAL_ERROR=t.INCORRECT_TO=t.INCORRECT_CC=t.INCORRECT_BCC=t.ILLEGAL_PARAMS=t.EMPTY_SUBJECT=t.DELAYED_MESSAGE_SAVED=t.DELAYED_CANNOT_SAVE=t.CAPTCHA=t.ACCESS_DENIED=void 0,t.ACCESS_DENIED="access_denied",t.CAPTCHA="captcha_request",t.DELAYED_CANNOT_SAVE="delayed_cannot_save",t.DELAYED_MESSAGE_SAVED="delayed_message_saved",t.EMPTY_SUBJECT="empty_subject",t.ILLEGAL_PARAMS="illegal_params",t.INCORRECT_BCC="incorrect_bcc",t.INCORRECT_CC="incorrect_cc",t.INCORRECT_TO="incorrect_to",t.INTERNAL_ERROR="internal_error",t.LIMIT_FAIL="fail_limit",t.MAX_EMAIL_ADDRESS_REACHED="max_email_addr_reached",t.NO_DATA="no_data",t.NO_NETWORK="http_status_0",t.NO_RECIPIENTS="no_recipients",t.SPAM="strongspam_found",t.TOO_BIG="msg_too_big",t.TOO_BIG_ATTACHMENTS="attachment_too_big",t.TOO_MANY_EMAILS="too_many_emails",t.UNDO_CANNOT_SAVE="undo_cannot_save",t.UNDO_MESSAGE_SAVED="undo_message_saved",t.UNDO_PAUSED="undo_paused",t.VIRUS="virus_found",t.TOO_MANY_SUBSCRIBERS="too_many_subscribers",t.MAILING_LIST_NOT_ALLOWED="mailing_list_not_allowed",t.UNDO_ERRORS=[t.UNDO_CANNOT_SAVE,t.UNDO_MESSAGE_SAVED,t.UNDO_PAUSED],t.RETRYABLE_ERRORS=[t.UNDO_CANNOT_SAVE,t.UNDO_MESSAGE_SAVED,t.UNDO_PAUSED,t.DELAYED_CANNOT_SAVE,t.DELAYED_MESSAGE_SAVED]},482:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NONE=t.SMALL=t.NORMAL=void 0,t.NORMAL="normal",t.SMALL="small",t.NONE="none"},483:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.INSERT_REPLACEMENT_TEXT=t.INSERT_MULTIPLE=t.INSERT_TEXT=t.INSERT_LINE_BREAK=t.INSERT_FROM_PASTE=t.DELETE_CONTENT_BACKWARD=t.DELETE_BY_CUT=void 0,t.DELETE_BY_CUT="deleteByCut",t.DELETE_CONTENT_BACKWARD="deleteContentBackward",t.INSERT_FROM_PASTE="insertFromPaste",t.INSERT_LINE_BREAK="insertLineBreak",t.INSERT_TEXT="insertText",t.INSERT_MULTIPLE="insertMultiple",t.INSERT_REPLACEMENT_TEXT="insertReplacementText"},484:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.NONE=t.NS_COMPOSE=t.AUTOCOMPLETE=void 0,t.AUTOCOMPLETE="Autocomplete",t.NS_COMPOSE="NsCompose",t.NONE="None"},485:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DRAFT_NOT_SAVED=t.DRAFT_REMOVED=t.DRAFT_SAVED=t.NO_CHANGES=void 0,t.NO_CHANGES="no changes",t.DRAFT_SAVED="draft saved",t.DRAFT_REMOVED="draft removed",t.DRAFT_NOT_SAVED="draft not saved"},486:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.SHOW_EXTERNAL_CONTACT_NOTIFICATION_ON_COMPOSE=t.LOCK_DEFAULT_EMAIL=t.CAN_WRITE_LETTERS=t.TWO_SIZES_HEADER_PROMO=t.TIMELINE_EXPANDED=t.STORED_COMPOSE_STATES=t.SIZE_LAYOUT_LEFT=t.SIZE_LAYOUT=t.SIGNATURE_TOP=t.RECIPIENTS_DIFF_PROMO_CLOSED=t.NS_COMPOSE_PROMO_CLOSED=t.NUMBER_OF_AUTOSAVE_PROMO_SHOW=t.LAST_USED_COMPOSE_SIZE=t.FROM_NAME=t.DEFAULT_EMAIL=t.ENABLE_HOTKEYS=t.ENABLE_AUTOSAVE=t.EMPTY_SUBJECT_POPUP_DISABLED=t.DISABLE_AUTOCOMPLETE_REACT=t.SUGGEST_BEAUTIFUL_EMAIL_PROMO_CLOSED=t.BEAUTIFUL_EMAIL_PROMO_CLOSED=t.MUTE_AUTOSAVE_PROMO_UNTIL=void 0,t.MUTE_AUTOSAVE_PROMO_UNTIL="mute_autosave_promo_until",t.BEAUTIFUL_EMAIL_PROMO_CLOSED="beautiful_email_compose_promo",t.SUGGEST_BEAUTIFUL_EMAIL_PROMO_CLOSED="beautiful_email_compose_promo",t.DISABLE_AUTOCOMPLETE_REACT="disable_autocomplete_react",t.EMPTY_SUBJECT_POPUP_DISABLED="empty_subject_popup_disabled",t.ENABLE_AUTOSAVE="enable_autosave",t.ENABLE_HOTKEYS="enable_hotkeys",t.DEFAULT_EMAIL="default_email",t.FROM_NAME="from_name",t.LAST_USED_COMPOSE_SIZE="last_used_compose_size",t.NUMBER_OF_AUTOSAVE_PROMO_SHOW="number_of_autosave_promo_show",t.NS_COMPOSE_PROMO_CLOSED="ns_compose_promo_closed",t.RECIPIENTS_DIFF_PROMO_CLOSED="kukutz-promo-closed",t.SIGNATURE_TOP="signature_top",t.SIZE_LAYOUT="size-view-app",t.SIZE_LAYOUT_LEFT="size-layout-left",t.STORED_COMPOSE_STATES="storedComposeStates",t.TIMELINE_EXPANDED="timeline-is-open",t.TWO_SIZES_HEADER_PROMO="two_sizes_header_promo",t.CAN_WRITE_LETTERS="can_write_letters",t.LOCK_DEFAULT_EMAIL="lock_employees_default_mail_domain",t.SHOW_EXTERNAL_CONTACT_NOTIFICATION_ON_COMPOSE="show_external_contact_notification_on_compose"},487:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.POPUP=t.INPUT=void 0,t.INPUT="line",t.POPUP="popup"},488:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.QUERY=t.POPULAR=void 0,t.POPULAR="popular",t.QUERY="query"},489:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BACKGROUND=t.FOREGROUND=void 0,t.FOREGROUND="foreground",t.BACKGROUND="background"},490:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BanReason=void 0,function(e){e.RfcFail="RfcFail",e.UrlRbl="UrlRbl",e.BadKarma="BadKarma",e.MailLimits="MailLimits",e.PddAdminKarma="PddAdminKarma",e.Bounces="Bounces",e.SpamCompl="SpamCompl"}(t.BanReason||(t.BanReason={}))},659:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"UNKNOWN",function(){return i}),n.d(t,"FILE_LIMIT",function(){return r}),n.d(t,"TOTAL_LIMIT",function(){return s}),n.d(t,"YADISK_ERROR",function(){return o}),n.d(t,"VIRUS",function(){return a}),n.d(t,"DISK_FULL",function(){return u}),n.d(t,"STATUS_DISK_FULL",function(){return c}),n.d(t,"DISK_TRAFFIC_LIMIT",function(){return l}),n.d(t,"DISK_TECHNICAL_WORK",function(){return d});var i=0,r=1,s=2,o=6,a=106,u=85,c=507,l=311,d=312},715:function(e,t,n){"use strict";n.d(t,"a",function(){return s});var i=n(136);n.n(i);function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}return function(e,t,n){t&&r(e.prototype,t),n&&r(e,n)}(e,[{key:"updateDraftAfterAction",value:function(e,t){if(t){var n=ns.Model.get("message",{ids:t});if(!e){ns.Model.traverse("messages",function(e){return e.remove(n)});var r=n.getThreadMessage();r&&r.hasRealData()&&r.updateThreadCount(-1)}var s=function(e){return e.isValid()&&e.params.ids===t};ns.Model.invalidate("message",s),ns.Model.invalidate("message-body",s),this.updateFolders(i.DraftLikeFoldersShort)}}},{key:"updateFolders",value:function(e){var t=Array.isArray(e)?e:[e],n=ns.Model.get("folders");return t.forEach(function(e){var t=n.getFidBySymbol(e);Daria.messages.clearCacheByFID(t)}),ns.forcedRequest(["folders","labels"]).then(function(){ns.router.buildFoldersUrls()})}},{key:"updateTemplateAfterAction",value:function(e){if(this.updateFolders(i.DraftTemplateLikeFoldersShort),e){var t=ns.Model.get("folders").getFidBySymbol(i.WellKnownFolderSymbol.TEMPLATE);ns.Model.get("message",{ids:e}).setIfChanged(".fid",t);var n=function(t){return t.isValid()&&t.params.ids===e};ns.Model.invalidate("message",n),ns.Model.invalidate("message-body",n)}}},{key:"updateMessageFlagsAfterSend",value:function(e,t){var n=t.isForward,i=t.isReply,r=t.replyMessageId;if(e&&e.length){var s=function(t){return e.forEach(function(e){return t(ns.Model.get("message",{ids:e}))})};n&&s(function(e){return e.markForwarded()}),i&&s(function(e){return e.markAnswered()}),ns.Model.invalidate("message-in-reply-to-ng",function(e){return e.params.message_id===r})}}},{key:"resetCheckedMessages",value:function(){"message"!==Daria.router.getCurrentPage()&&(ns.Model.get("messages-checked").resetChecked(),ns.events.trigger("daria:vToolbarButton:restruct",{force:!0}))}},{key:"updateOutboxAfterAction",value:function(){this.updateFolders([i.WellKnownFolderSymbol.OUTBOX])}}]),e}()},716:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"NEW",function(){return i}),n.d(t,"UPLOADING",function(){return r}),n.d(t,"COMPLETED",function(){return s}),n.d(t,"FAILED",function(){return o}),n.d(t,"VIRUS",function(){return a}),n.d(t,"ABORTED",function(){return u}),n.d(t,"RESTRICTED",function(){return c});var i=0,r=1,s=2,o=3,a=4,u=5,c=6},717:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"FILE",function(){return i}),n.d(t,"YADISK",function(){return r}),n.d(t,"FORWARDED_MAIL",function(){return s});var i="simple",r="narod",s="forwarded"},720:function(e,t,n){"use strict";var i=n(999);n.d(t,"a",function(){return i.a})},995:function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),n.d(t,"LOCAL",function(){return i}),n.d(t,"DISK",function(){return r});var i="local",r="disk"},996:function(e,t,n){"use strict";!Daria.IS_CORP&&Daria.SIDS.indexOf("59"),Daria.IS_CORP,Daria.IS_CORP},997:function(e,t,n){"use strict";var i=n(349);t.a=function(e,t){switch(e.type){case i.c.FILE:return{att_id:e.att_id,hid:e.hid,from_template:e.from_template,template_hid:e.template_hid,template_mid:e.template_mid};case i.c.YADISK:return{disk:t===i.b.COMPLETED?function(e){return Daria.utils.getDiskParams(e)}(e):""}}}},999:function(e,t,n){"use strict";n.d(t,"a",function(){return c});var i=n(325),r=n(135),s=(n.n(r),n(136)),o=(n.n(s),n(338)),a=(n.n(o),n(329));function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var c=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=arguments.length>1?arguments[1]:void 0;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.newMessageId=void 0,t.tids&&!t.tids.length&&delete t.tids;var i=t.mailboxUid||null;this.params=t,this.data=n,this.mSettings=i?ns.Model.get("mailbox-settings",{mailboxUid:i}):ns.Model.get("settings")}return function(e,t,n){t&&u(e.prototype,t),n&&u(e,n)}(e,[{key:"getParams",value:function(){return this.params}},{key:"getMessageType",value:function(){return Daria.UA.isMobile&&!Daria.UA.isTouch?"plain":"html"}},{key:"getFromName",value:function(){return this.mSettings.getSetting(o.Settings.FROM_NAME)}},{key:"getFromEmail",value:function(){return this.mSettings.getSetting(o.Settings.LOCK_DEFAULT_EMAIL)?this.mSettings.getSetting(o.Settings.DEFAULT_EMAIL):this.mMessage&&this.mMessage.getToEmail()||this.mSettings.getSetting(o.Settings.DEFAULT_EMAIL)}},{key:"getAvailableFromEmails",value:function(){var e=this.mAccountInformation.getFromEmails();return this.mSettings.getSetting(o.Settings.LOCK_DEFAULT_EMAIL)?[this.mSettings.getSetting(o.Settings.DEFAULT_EMAIL)]:e}},{key:"_getForwardMarkIds",value:function(){return this.mMessage?this.mMessage.isThread()&&1===this.mMessage.get(".count")?[this.mMessage.get(".last_mid")]:this.mMessage.isThread()?[]:[this.mMessage.get(".mid")]:[]}},{key:"isForward",value:function(){return Boolean("forward"===this.params.oper)}},{key:"isTemplate",value:function(){return!(!this.mMessage||!this.mMessage.isTemplate())||!(!this.data||this.data.save_symbol!==s.WellKnownFolderSymbol.TEMPLATE)}},{key:"isDraft",value:function(){return!this.isTemplate()&&(!(!this.data||"no"!==this.data.ign_overwrite||!this.data.overwrite)||!!(this.mMessage&&this.mMessageBody&&this.mMessage.isDraftLike()))}},{key:"isReplyAll",value:function(){return Boolean(this.mMessageBody&&"reply-all"===this.params.oper)}},{key:"isReply",value:function(){return Boolean(this.mMessageBody&&"reply"===this.params.oper)}},{key:"isReplyAny",value:function(){return this.isReply()||this.isReplyAll()}},{key:"getForwardData",value:function(){var e=this.getMessageType(),t=this.getFromEmail(),n=this.mMessage?this.mMessage.getFolderId():null,i=this.mMessageBody?this.mMessageBody.getForwardBody(e,t):Daria.signs.appendToBody("",e,!0,t,null,this.mailboxUid),r=this.mMessageBody?this.mMessageBody.getMessageId():null;return{ttype:e,from_mailbox:t,from_name:this.getFromName(),cc:"",bcc:"",subj:"Fwd: "+this.messageSubject,send:i,inreplyto:r,current_folder:n,overwrite:this.params.ids,ign_overwrite:"yes",references:"",mark_ids:this._getForwardMarkIds(),mark_as:"forwarded",message_id:this.newMessageId}}},{key:"getDraftData",value:function(){var e=this.getMessageType(),t=this.mMessage.isTemplate()?s.WellKnownFolderSymbol.TEMPLATE:s.WellKnownFolderSymbol.DRAFT,n=_.clone(this.mMessage.get(".lid")),i=this.mMessage.getDelayedTime(),r=this.isTemplate()?this.newMessageId:this.mMessage.get(".message_id"),o=this.params.mailboxUid;if(!i){var a=ns.Model.get("labels",{mailboxUid:o}).getDelayedMessageLabel();a&&(n=_.pull(n,a.lid))}return{overwrite:this.params.ids,ign_overwrite:"no",save_symbol:t,to:this.mMessageBody.getAddressField("to"),cc:this.mMessageBody.getAddressField("cc"),bcc:this.mMessageBody.getAddressField("bcc"),phone:this.mMessageBody.getAddressField("phone"),lids:n,from_name:this.mMessage.getFromName(),from_mailbox:this.mMessage.getFromEmail(),subj:this.messageSubjectWithPrefix,send:this.mMessageBody.getDraftBody(e),ttype:e,inreplyto:this.mMessageBody.getInReplyTo(),references:this.mMessageBody.getReferences(),current_folder:this.mMessage.getFolderId(),send_time:i,message_id:r}}},{key:"getTemplateData",value:function(){if(this.mMessage&&this.mMessageBody)return this.draftMessageData;var e=this.defaultMessageData;return e.save_symbol=s.WellKnownFolderSymbol.TEMPLATE,e}},{key:"getReplyData",value:function(){var e=this.getMessageType(),t=this.mMessageBody.getRecipients(this.isReplyAll()),n=this.mMessageBody.getMessageId(),i=this.mMessageBody.getReferences(),r=this.mMessageBody.getInReplyTo(),s=this.mMessageBody.getInfo("delivered-to")[0],o=this.fromEmail,a=this.params.isQuickReply?"":this.sendMessageData;return{from:{receiver:s},from_mailbox:o,from_name:this.getFromName(),overwrite:this.params.ids,ign_overwrite:"yes",mark_as:"replied",mark_ids:[this.params.ids],to:t.to,cc:t.cc,bcc:"",subj:"Re: "+this.messageSubject,send:a,ttype:e,inreplyto:n,references:_.trim((i||r||"")+" "+n),message_id:this.newMessageId}}},{key:"getSendMessage",value:function(){return(this.data&&this.data.qrText||"")+this.getReplyBody()}},{key:"getReplyBody",value:function(){var e=this.getMessageType(),t=this.fromEmail;return this.mMessageBody.getReplyBody(e,t)}},{key:"getDefaultData",value:function(){var e=this.getFromEmail()||this.mAccountInformation.getFromDefaultEmail(),t=this.getFromName(),n=this.getMessageType(),i=this.data&&this.data.send||"";return Object(r.isEmpty)(i)||"html"!==this.getMessageType()||(i="<div>".concat(i,"</div>")),{from_mailbox:e,from_name:t,ttype:n,send:Daria.signs.appendToBody(i,n,!0,e,void 0,this.mailboxUid),message_id:this.newMessageId}}},{key:"getComposeMessageData",value:function(){return this.isDraft()?this.draftMessageData:this.isTemplate()?this.templateMessageData:this.isReplyAny()?this.replyMessageData:this.isForward()?this.forwardMessageData:this.defaultMessageData}},{key:"isPredefinedDataEmpty",value:function(){var e=Object(i.toJS)(this.data);return!e||0===Object.keys(e).length}},{key:"getRelatedThreadId",value:function(){return this.mMessage?this.mMessage.getThreadId():""}},{key:"isNewMessage",value:function(){return!this.isDraft()&&!this.isReplyAny()&&!this.isForward()}},{key:"isNewTemplate",value:function(){var e=this.data&&this.data.overwrite||this.mMessage&&this.mMessage.isDraftLike();return this.isTemplate()&&!e}},{key:"mailboxUid",get:function(){return this.params.mailboxUid}},{key:"hasMessage",get:function(){return this.params.ids&&!this.params.tids}},{key:"mMessage",get:function(){return this.hasMessage?ns.Model.getValid("message",{ids:this.params.ids,mailboxUid:this.mailboxUid}):null}},{key:"mThread",get:function(){return this.hasMessage?null:ns.Model.getValid("message",{ids:this.params.tids,mailboxUid:this.mailboxUid})}},{key:"mMessageBody",get:function(){if(!this.hasMessage)return null;var e=ns.Model.infoLite("message-body").calculateParamsForMessageBody(this.params);return ns.Model.getValid("message-body",e)}},{key:"mAccountInformation",get:function(){return Object(a.isSharedMailboxes)()&&this.mailboxUid?ns.Model.get("address-information"):ns.Model.get("account-information")}},{key:"fromName",get:function(){return this.getFromName()}},{key:"fromEmail",get:function(){return this.getFromEmail()}},{key:"fromEmails",get:function(){return this.getAvailableFromEmails()}},{key:"forwardMessageData",get:function(){return this.getForwardData()}},{key:"messageSubject",get:function(){var e=this.mMessage||this.mThread;return e?e.getSubject(!0):""}},{key:"messageSubjectWithPrefix",get:function(){var e=this.mMessage||this.mThread;return e?e.getSubject():""}},{key:"draftMessageData",get:function(){return this.getDraftData()}},{key:"templateMessageData",get:function(){return this.getTemplateData()}},{key:"replyMessageData",get:function(){return this.getReplyData()}},{key:"sendMessageData",get:function(){return this.getSendMessage()}},{key:"defaultMessageData",get:function(){return this.getDefaultData()}},{key:"messageData",get:function(){return this.getComposeMessageData()}},{key:"relatedThreadId",get:function(){return this.getRelatedThreadId()}}]),e}()}});